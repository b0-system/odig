<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>contributing (odoc.contributing)</title><link rel="stylesheet" href="../_odoc-theme/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.0.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="index.html">Up</a> – <a href="index.html">odoc</a> &#x00BB; contributing</nav><header class="odoc-preamble"><h1 id="contributing-to-odoc"><a href="#contributing-to-odoc" class="anchor"></a>Contributing to <code>odoc</code></h1><p>Please ask any questions you have about <code>odoc</code>, <a href="https://github.com/ocaml/odoc/issues">open any issues</a>, <a href="https://github.com/ocaml/odoc#contact">offer feedback</a>, etc. All of these are valued contributions :)</p><p>If you'd like specifically to work on the code of <code>odoc</code>, we hope that you will find the information in this file helpful.</p></header><nav class="odoc-toc"><ul><li><a href="#quick-start:-html-and-css">Quick start: HTML and CSS</a></li><li><a href="#testing">Testing</a><ul><li><a href="#cram-tests">Cram Tests</a></li><li><a href="#other-expect-tests">Other Expect-Tests</a></li></ul></li><li><a href="#coverage-analysis">Coverage Analysis</a></li><li><a href="#ci-tests">CI Tests</a></li><li><a href="#api-reference">API Reference</a><ul><li><a href="#loading">Loading</a></li><li><a href="#model">Model</a></li><li><a href="#resolution-and-expansion">Resolution and Expansion</a></li><li><a href="#intermediate-representation-and-renderers">Intermediate Representation and Renderers</a></li><li><a href="#cli-and-driver">CLI and Driver</a></li><li><a href="#test-and-internal-libraries">Test and Internal Libraries</a></li></ul></li><li><a href="#dependency-libraries">Dependency Libraries</a></li></ul></nav><div class="odoc-content"><h2 id="quick-start:-html-and-css"><a href="#quick-start:-html-and-css" class="anchor"></a>Quick start: HTML and CSS</h2><p>The <code>odoc</code> CSS is found at <a href="https://github.com/ocaml/odoc/blob/master/src/odoc/etc/odoc.css"><code>src/odoc/etc/odoc.css</code></a>. It still needs work, and PRs are very welcome. You can edit CSS using your browser's <a href="https://developer.mozilla.org/en-US/docs/Tools">developer</a> <a href="https://developer.chrome.com/docs/devtools/">tools</a>. Then send us a PR for the same changes made to this file.</p><p>Working on the HTML is more involved. The main HTML generator is in <a href="https://github.com/ocaml/odoc/blob/master/src/html/generator.ml"><code>src/html/generator.ml</code></a>. It operates on the types defined in <a href="Odoc_document/Types/index.html"><code>Odoc_document.Types</code></a>, which is an intermediate representation used by all output renderers. The type that describes an individual HTML page is <a href="Odoc_document/Types/Page/index.html#type-t"><code>Odoc_document.Types.Page.t</code></a>.</p><p>To make edits to the HTML generation, run the following commands:</p><ol><li><p>Install requirements:</p><ul><li><p>A recent version of <a href="http://www.html-tidy.org/">HTML tidy</a> (used for HTML validity testing) is required:</p><pre><code># On MacOS (should be version 5.6.0 by the date of this writing)
brew install tidy-html5     
# Debian / Ubuntu
sudo apt-get install tidy</code></pre></li><li><p>A recent version of <a href="https://github.com/stedolan/jq">jq</a> is required.</p><pre><code># On MacOS
brew install jq

# Debian / Ubuntu
sudo apt-get install jq</code></pre></li></ul></li><li><p>Set up for development:</p><pre><code>git clone https://github.com/ocaml/odoc.git
cd odoc
opam pin add --no-action odoc .
opam install --with-test --deps-only odoc
opam install mdx</code></pre></li><li><p>Make changes to the code. To compile it,</p><pre><code>make</code></pre><p>and then to run the tests,</p><pre><code>make test</code></pre><p>Changes to the HTML are likely to cause the tests to fail. See the section on <a href="#testing">testing</a> below to understand how to update them.</p></li><li><p>To test <code>odoc</code> against your own project, install it</p><pre><code>make clean
opam install odoc</code></pre><p>Since <code>odoc</code> is pinned, this installs your modified version. Then you can run <code>odoc</code> in your project as normal:</p><pre><code>dune build @doc</code></pre></li><li>If all looks good, send odoc a PR :)</li></ol><h2 id="testing"><a href="#testing" class="anchor"></a>Testing</h2><p><code>odoc</code> uses a variety of different test types. We are slowly converging on using Dune's <a href="https://dune.readthedocs.io/en/stable/tests.html#cram-tests">cram tests</a>, though we still have many tests that aren't yet converted.</p><h3 id="cram-tests"><a href="#cram-tests" class="anchor"></a>Cram Tests</h3><p>The tests extensively use these for the model layer and are found in <a href="https://github.com/ocaml/odoc/blob/master/test/xref2"><code>test/xref2</code></a>. These consist of a directory called <code>something.t</code>, containing a file <code>run.t</code>. This file has shell-like syntax and usually runs <code>odoc</code> on some carefully crafted input files. For tests of the model layer it's often useful to use the binary <code>odoc_print</code> which can dump <code>.odoc</code> and <code>.odocl</code> files as JSON. This output can then be piped through <code>jq</code> to verify that values are as expected.</p><p>We try to make these test files describe the test and what's expected, which helps when the output isn’t what the test expected. This also means that the tests can serve as documentation of how things work. As an example, see the file <a href="https://github.com/ocaml/odoc/blob/master/test/xref2/multi_file_module_type_of.t/run.t"><code>test/xref2/multi_file_module_type_of.t/run.t</code></a></p><p>The tests work by executing the shell script snippets and then comparing the actual output with those in the <code>run.t</code> files. If these <em>don't</em> match, the difference is rendered as a diff. For example, if I change the way <code>type</code> declarations are printed and run <code>dune runtest</code>, I get the following output:</p><pre><code>------ test/xref2/module_type_of.t/run.t
++++++ test/xref2/module_type_of.t/run.t.corrected
File &quot;test/xref2/module_type_of.t/run.t&quot;, line 95, characters 0-1:
 |                ]
 |              },
 |              &quot;T&quot;
 |            ]
 |          },
 |          &quot;Z&quot;
 |        ]
 |      }
 |    }
 |  ]
 |
 |Check that the expansion of 'T.Y' contains only 1 type
 |
 |  $ jq &quot;.[0].ModuleType.expr.Some.TypeOf.t_expansion.Some.Signature.items&quot; &lt; T_sig.json &gt; T.Y_sig.json
 |  $ odoc_print m.odocl | jq &quot;map(keys | .[0])&quot; &lt; T.Y_sig.json
 |  [
-|    &quot;Type&quot;
+|    &quot;Toupe&quot;
 |  ]
 |</code></pre><p>The intended response to this is:</p><ol><li>Check the diff. If the <code>-</code> line is correct, the code is broken. If the <code>+</code> line is correct, the test is broken.</li><li>If the test is broken, run <code>dune promote</code> to replace the expected output with the current output.</li></ol><h3 id="other-expect-tests"><a href="#other-expect-tests" class="anchor"></a>Other Expect-Tests</h3><p>Many of <code>odoc</code>'s older tests are <b>custom Expect-tests</b>, similar to those run in the Cram test above, but that don't use Dune's <code>promote</code> workflow. As an example the parser tests in <code>test/parser</code> work in the following way:</p><ol><li>The tests run some code, e.g., the <code>odoc</code> parser on the string <code>{e foo}</code>.</li><li>They take the output, in this case an AST representing &quot;emphasized <code>foo</code>,&quot; and convert that output to a string, which will be an S-expression roughly like <code>(emphasis (foo))</code>.</li><li>There is an <b>expected</b> copy of this S-expression in a file somewhere in the repo. If the S-expression from the code doesn't match the expected one, the test fails.</li></ol><p>When one of these Expect-tests fail, the output is saved, so the developer can choose to <b>replace</b> the now-incorrect expected string. For these custom Expect-tests, the results may look like:</p><pre><code>-- bold.000 [basic.] Failed --
in _build/_tests/bold.000.output:

{e foo}

--- expect/bold/basic.txt       2018-04-15 14:42:32.356895400 -0500
+++ _actual/bold/basic.txt      2018-04-15 17:36:26.812747400 -0500
@@ -2,5 +2,5 @@
   (ok
    (((f.ml (1 0) (1 7))
      (paragraph
-      (((f.ml (1 0) (1 7)) (bold (((f.ml (1 3) (1 6)) (word foo)))))))))))
+      (((f.ml (1 0) (1 7)) (emphasis (((f.ml (1 3) (1 6)) (word foo)))))))))))
  (warnings ()))

To replace expected output with actual, run

bash _build/default/test/parser/_actual/replace.sh</code></pre><p>As with the Cram tests, the idea is to examine the diff to see if your code is broken or the test is broken. If the test is broken, the actual results may be promoted to the expected results by running the suggested command. If your code is broken, go and fix it!</p><p>We are slowly shifting these custom Expect-tests over to the Dune <code>promote</code> workflow.</p><h2 id="coverage-analysis"><a href="#coverage-analysis" class="anchor"></a>Coverage Analysis</h2><p>The <code>odoc</code> repo is set up for coverage analysis. This is most useful if you're writing new tests, and want to know what they’re actually touching.</p><p>To use it,</p><ol><li><p>Run <code>make coverage</code>. This will run the tests as normal, except at the end you’ll get a message like</p><pre><code>See _coverage/index.html</code></pre><p>You can then open <code>_coverage/index.html</code> and see the coverage of the code you’d like your new test to reach. However, it’s possible that it’s already covered &quot;accidentally&quot; by tests that are checking other properties. In which case, coverage analysis won’t be very useful :)</p></li><li>Write new tests.</li><li>Check coverage again.</li></ol><h2 id="ci-tests"><a href="#ci-tests" class="anchor"></a>CI Tests</h2><p><code>odoc</code> is tested by <a href="https://ci.ocamllabs.io/">ocaml-ci</a> and by GitHub workflows. One of these also does a coverage build, so we have up-to-date coverage stats on <a href="https://coveralls.io/github/ocaml/odoc">Coveralls</a>.</p><p>The tests cover Esy and Opam builds on Windows, macOS, and Linux. The Linux tests cover all supported versions of OCaml. We strive to retain compatibility back as far as we can (currently 4.02) which is important for supporting <a href="https://ocaml.org/docs/">ocaml.org/docs</a>.</p><h2 id="api-reference"><a href="#api-reference" class="anchor"></a>API Reference</h2><h3 id="loading"><a href="#loading" class="anchor"></a>Loading</h3><p>The library <span class="xref-unresolved">odoc.loader</span> is responsible for converting from the OCaml <a href="../ocaml/Typedtree/index.html"><code>Typedtree</code></a> representations to the <a href="Odoc_model/Lang/index.html">internal representation</a>.</p><h3 id="model"><a href="#model" class="anchor"></a>Model</h3><p>The library <span class="xref-unresolved">odoc.model</span> contains definitions of the internal types used to represent OCaml interfaces.</p><h3 id="resolution-and-expansion"><a href="#resolution-and-expansion" class="anchor"></a>Resolution and Expansion</h3><p>Resolution of Paths, Fragments and References, and Expansion of Modules and Module Types are handled by the <span class="xref-unresolved">odoc.xref2 library</span>.</p><h3 id="intermediate-representation-and-renderers"><a href="#intermediate-representation-and-renderers" class="anchor"></a>Intermediate Representation and Renderers</h3><p>The generic documentation intermediate format is defined in the <span class="xref-unresolved">odoc.document library</span>.</p><p>The three current renderers are implemented within the following libraries <span class="xref-unresolved">odoc.html</span>, <span class="xref-unresolved">odoc.latex</span>, and <span class="xref-unresolved">odoc.manpage</span>.</p><h3 id="cli-and-driver"><a href="#cli-and-driver" class="anchor"></a>CLI and Driver</h3><p>The CLI for <code>odoc</code> and various helper functions for driving the process are contained in the <span class="xref-unresolved">odoc.odoc library</span>.</p><h3 id="test-and-internal-libraries"><a href="#test-and-internal-libraries" class="anchor"></a>Test and Internal Libraries</h3><p>There are a couple of libraries used internally for testing - <span class="xref-unresolved">odoc.xref_test</span> and <span class="xref-unresolved">odoc.model_desc</span>.</p><h2 id="dependency-libraries"><a href="#dependency-libraries" class="anchor"></a>Dependency Libraries</h2><p>There are several <a href="deps.html">dependency libraries</a> that <code>odoc</code> uses, whose functions, type, and module declarations are essential for understanding how <code>odoc</code> works. See the <a href="driver.html">driver</a> page for details on how the documentation for these libraries are included.</p></div></body></html>