<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Notty (notty.Notty)</title><link rel="stylesheet" href="../../_odoc-theme/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.0.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../index.html">notty</a> &#x00BB; Notty</nav><header class="odoc-preamble"><h1>Module <code><span>Notty</span></code></h1><p>Declaring terminals.</p><p>Notty is a terminal library that revolves around construction and composition of displayable images.</p><p>This module provides the core <a href="I/index.html"><code>image</code></a> abstraction, standalone <a href="Render/index.html">rendering</a>, and escape sequence <a href="Unescape/index.html">parsing</a>. It does not depend on any platform code, and does not interact with the environment. Input and output are provided by <a href="../Notty_unix/index.html"><code>Notty_unix</code></a> and <a href="../Notty_lwt/index.html"><code>Notty_lwt</code></a>.</p><p>Consult the <a href="#basics">basics</a>, <a href="#examples">examples</a> and <a href="#limitations">limitations</a>.</p><p><em>v0.2.2 — <a href="https://github.com/pqwy/notty">homepage</a></em></p></header><nav class="odoc-toc"><ul><li><a href="#interface">Interface</a></li><li><a href="#low-level-interface">Low-level interface</a></li><li><a href="#basics">Basics</a><ul><li><a href="#meaning">The meaning of images</a></li><li><a href="#attributes">Display attributes</a></li><li><a href="#ctrls">Control characters</a></li></ul></li><li><a href="#limitations">Limitations</a><ul><li><a href="#cwidth">Unicode vs. Text geometry</a></li></ul></li><li><a href="#examples">Examples</a><ul><li><a href="#hello">Hello</a></li><li><a href="#colors_2">Colors</a></li><li><a href="#padding-and-spacing">Padding and spacing</a></li><li><a href="#more-geometry">More geometry</a></li><li><a href="#pretty-printing">Pretty-printing</a></li><li><a href="#now-with-output">Now with output</a></li><li><a href="#simple-interaction">Simple interaction</a></li></ul></li><li><a href="#perf">Performance model</a></li></ul></nav><div class="odoc-content"><h2 id="interface"><a href="#interface" class="anchor"></a>Interface</h2><div class="odoc-spec"><div class="spec type" id="type-attr" class="anchored"><a href="#type-attr" class="anchor"></a><code><span><span class="keyword">type</span> attr</span></code></div><div class="spec-doc"><p>Visual characteristics of displayed text.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-image" class="anchored"><a href="#type-image" class="anchor"></a><code><span><span class="keyword">type</span> image</span></code></div><div class="spec-doc"><p>Rectangles of styled characters.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-A" class="anchored"><a href="#module-A" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="A/index.html">A</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p><code>A</code> is for attribute.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-I" class="anchored"><a href="#module-I" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="I/index.html">I</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p><code>I</code> is for image.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Infix" class="anchored"><a href="#module-Infix" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Infix/index.html">Infix</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Operators, repeated.</p></div></div><h2 id="low-level-interface"><a href="#low-level-interface" class="anchor"></a>Low-level interface</h2><p>You can ignore it, unless you are porting <code>Notty</code> to a new platform not supported by the existing IO backends.</p><div class="odoc-spec"><div class="spec module" id="module-Cap" class="anchored"><a href="#module-Cap" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Cap/index.html">Cap</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Terminal capabilities.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Render" class="anchored"><a href="#module-Render" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Render/index.html">Render</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Dump images to string buffers.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Unescape" class="anchored"><a href="#module-Unescape" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Unescape/index.html">Unescape</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Parse and decode escape sequences in character streams.</p></div></div><h2 id="basics"><a href="#basics" class="anchor"></a>Basics</h2><p>Print a red-on-black <code>&quot;Wow!&quot;</code> above its right-shifted copy:</p><pre><code>let wow = I.string A.(fg red ++ bg black) &quot;Wow!&quot; in
I.(wow &lt;-&gt; (void 2 0 &lt;|&gt; wow)) |&gt; Notty_unix.output_image</code></pre><h3 id="meaning"><a href="#meaning" class="anchor"></a>The meaning of images</h3><p>An <a href="#type-image"><code>image</code></a> value is a rectangle of styled character cells. It has a width and height, but is not anchored to an origin. A single character with associated display attributes, or a short fragment of text, are simple examples of images.</p><p>Images are created by combining text fragments with <a href="#attributes">display attributes</a>, and composed by placing them <a href="I/index.html#val-(&lt;|&gt;)">beside</a> each other, <a href="I/index.html#val-(&lt;-&gt;)">above</a> each other, and <a href="I/index.html#val-(&lt;/&gt;)">over</a> each other.</p><p>Once constructed, an image can be rendered, and only at that point it obtains absolute placement.</p><p>Consult <a href="I/index.html"><code>I</code></a> for more details.</p><h3 id="attributes"><a href="#attributes" class="anchor"></a>Display attributes</h3><p><a href="#type-attr"><code>attr</code></a> values describe the styling characteristics of fragments of text.</p><p>They combine a foreground and a background <a href="A/index.html#type-color"><code>color</code></a> with a set of <a href="A/index.html#type-style"><code>styles</code></a>. Either color can be <em>unset</em>, which corresponds to the terminal's default foreground (resp. background) color.</p><p>Attributes are used to construct primitive images.</p><p>Consult <a href="A/index.html"><code>A</code></a> for more details.</p><h3 id="ctrls"><a href="#ctrls" class="anchor"></a>Control characters</h3><p>These are taken to be characters in the ranges <code>0x00-0x1f</code> (<b>C0</b>), <code>0x7f</code> (BACKSPACE), <code>0x80-0x9f</code> (<b>C1</b>). This is the <a href="http://unicode.org/reports/tr44/#General_Category_Values">Unicode general category</a> <b>Cc</b>.</p><p>As control characters directly influence the cursor positioning, they cannot be used to create images.</p><p>This, in particular, means that images cannot contain <code>U+000a</code> (NEWLINE).</p><h2 id="limitations"><a href="#limitations" class="anchor"></a>Limitations</h2><p><code>Notty</code> does not use Terminfo. If your terminal is particularly idiosyncratic, things might fail to work. Get in touch with the author to expand support.</p><p><code>Notty</code> assumes that the terminal is using UTF-8 for input and output. Things might break arbitrarily if this is not the case.</p><p>For performance considerations, consult the <a href="#perf">performance model</a>.</p><h3 id="cwidth"><a href="#cwidth" class="anchor"></a>Unicode vs. Text geometry</h3><p><code>Notty</code> uses <code>Uucp.Break.tty_width_hint</code> to guess the width of text fragments when computing geometry, and it suffers from the same shortcomings:</p><ul><li>Geometry in general works for alphabets and east Asian scripts, mostly works for abjad scripts, and is a matter of luck for abugidas.</li><li>East Asian scripts work better when in <a href="http://unicode.org/glossary/#normalization_form_c">NFC</a>.</li><li>For proper emoji display, <code>Uucp</code> and the terminal have to agree on the Unicode version.</li></ul><p>When in doubt, see <a href="http://erratique.ch/software/uucp/doc/Uucp.Break.html#VALtty_width_hint"><code>Uucp.Break.tty_width_hint</code></a>.</p><p>Unicode has special interaction with <a href="I/index.html#val-hcrop">horizontal cropping</a>:</p><ul><li>Strings within images are cropped at <a href="http://unicode.org/reports/tr29/#Grapheme_Cluster_Boundaries">grapheme cluster</a> boundaries. This means that scalar value sequences that are rendered combined, or overlaid, stay unbroken.</li><li>When a crop splits a wide character in two, the remaining half is replaced by <code>U+0020</code> (SPACE). Hence, character-cell-accurate cropping is possible even in the presence of characters that horizontally occupy more than one cell.</li></ul><h2 id="examples"><a href="#examples" class="anchor"></a>Examples</h2><p>We assume a toplevel with <code>Notty</code> support (<code>#require &quot;notty.top&quot;</code>).</p><h3 id="hello"><a href="#hello" class="anchor"></a>Hello</h3><p><code>&quot;Rad!&quot;</code> with default foreground and background:</p><pre><code>I.string A.empty &quot;Rad!&quot;</code></pre><p>Everything has to start somewhere.</p><h3 id="colors_2"><a href="#colors_2" class="anchor"></a>Colors</h3><p><code>&quot;Rad!&quot;</code> in rad letters:</p><pre><code>I.string A.(fg lightred) &quot;Rad!&quot;</code></pre><h3 id="padding-and-spacing"><a href="#padding-and-spacing" class="anchor"></a>Padding and spacing</h3><pre><code>let a1 = A.(fg lightwhite ++ bg red)
and a2 = A.(fg red)</code></pre><p><code>&quot;Rad&quot;</code> and <code>&quot; stuff!&quot;</code> in different colors:</p><pre><code>I.(string a1 &quot;Rad&quot; &lt;|&gt; string a2 &quot; stuff!&quot;)</code></pre><p>The second word hanging on a line below:</p><pre><code>I.(string a1 &quot;Rad&quot; &lt;|&gt; (string a2 &quot;stuff!&quot; |&gt; vpad 1 0))</code></pre><h3 id="more-geometry"><a href="#more-geometry" class="anchor"></a>More geometry</h3><p>Sierpinski triangle:</p><pre><code>let square = &quot;\xe2\x96\xaa&quot;

let rec sierp n =
  if n &gt; 1 then
    let ss = sierp (pred n) in I.(ss &lt;-&gt; (ss &lt;|&gt; ss))
  else I.(string A.(fg magenta) square |&gt; hpad 1 0)</code></pre><pre><code>sierp 8</code></pre><p>A triangle overlaid over its shifted copy:</p><pre><code>let s = sierp 6 in I.(s &lt;/&gt; vpad 1 0 s)</code></pre><p>Blinkenlights:</p><pre><code>let rad n color =
  let a1 = A.fg color in
  let a2 = A.(st blink ++ a1) in
  I.((string a2 &quot;Rad&quot; |&gt; hpad n 0) &lt;-&gt;
     (string a1 &quot;(⌐■_■)&quot; |&gt; hpad (n + 7) 0))

let colors = A.[red; green; yellow; blue; magenta; cyan]</code></pre><pre><code>colors |&gt; List.mapi I.(fun i c -&gt; rad i c |&gt; pad ~t:i ~l:(2 * i))
       |&gt; I.zcat</code></pre><p><b>Note</b> Usage of <a href="A/index.html#val-blink"><code>blink</code></a> might be regulated by law in some jurisdictions.</p><h3 id="pretty-printing"><a href="#pretty-printing" class="anchor"></a>Pretty-printing</h3><p>Images can be pretty-printed into:</p><pre><code>I.strf &quot;(%d)&quot; 42</code></pre><p>Attributes can be applied to the entire format string, or by decorating <em>user-defined printers</em> that are supplied with <code>%a</code> conversions:</p><pre><code>let pp = Format.pp_print_int</code></pre><pre><code>I.strf ~attr:A.(fg lightwhite) &quot;(%a)&quot; (I.pp_attr A.(fg green) pp) 42</code></pre><h3 id="now-with-output"><a href="#now-with-output" class="anchor"></a>Now with output</h3><p>The core module has no real IO. Examples above are simple <code>image</code>-valued expressions, displayed by the pretty-printer that is installed by the toplevel support. Self-contained programs need a separate IO module:</p><pre><code>#require &quot;notty.unix&quot;</code></pre><pre><code>sierp 8 |&gt; Notty_unix.output_image</code></pre><p>(Note the difference in cropping behavior.)</p><p>Computations can be adapted to the current terminal size. A line can stretch end-to-end:</p><pre><code>Notty_unix.output_image_size @@ fun (w, _) -&gt;
  let i1 = I.string A.(fg green) &quot;very&quot;
  and i2 = I.string A.(fg yellow) &quot;melon&quot; in
  I.(i1 &lt;|&gt; void (w - width i1 - width i2) 1 &lt;|&gt; i2)</code></pre><p>The largest triangle that horizontally fits into the terminal:</p><pre><code>Notty_unix.output_image_size @@ fun (w, _) -&gt;
  let steps = int_of_float ((log (float w)) /. log 2.) in
  sierp steps |&gt; I.vpad 0 1</code></pre><h3 id="simple-interaction"><a href="#simple-interaction" class="anchor"></a>Simple interaction</h3><p>Interactive Sierpinski:</p><pre><code>open Notty_unix</code></pre><pre><code>let img (double, n) =
  let s = sierp n in
  if double then I.(s &lt;/&gt; vpad 1 0 s) else s
in
let rec update t state = Term.image t (img state); loop t state
and loop t (double, n as state) =
  match Term.event t with
  | `Key (`Enter,_)        -&gt; ()
  | `Key (`Arrow `Left,_)  -&gt; update t (double, max 1 (n - 1))
  | `Key (`Arrow `Right,_) -&gt; update t (double, min 8 (n + 1))
  | `Key (`ASCII ' ', _)   -&gt; update t (not double, n)
  | `Resize _              -&gt; update t state
  | _                      -&gt; loop t state
in
let t = Term.create ()
in
update t (false, 1); Term.release t</code></pre><p>The program uses a fullscreen <a href="../Notty_unix/Term/index.html">terminal</a> and loops reading the <a href="../Notty_unix/Term/index.html#val-event">input</a>. LEFT and RIGHT control the iteration count, and SPACE toggles double-drawing. Resizing the window causes a redraw. When the loop exits on ENTER, the terminal is <a href="../Notty_unix/Term/index.html#val-release">cleaned up</a>.</p><h2 id="perf"><a href="#perf" class="anchor"></a>Performance model</h2><p>This section is only relevant if using <code>Notty</code> becomes your bottleneck.</p><p><b>TL;DR</b> Shared sub-expressions do not share work, so operators stick with you.</p><p>The main performance parameter is <em>image complexity</em>. This roughly corresponds to the number of image <a href="I/index.html#imgcomp">composition</a> and <a href="I/index.html#imgcrop">cropping</a> operators in the fully expanded <code>image</code> term, <b>ignoring all sharing</b>.</p><p>Outline numbers:</p><ul><li>Highly complex images can be rendered and pushed out to a full-screen terminal more than 1000 times per second.</li><li>With more realistic images, this number is closer to 30,000.</li><li>Input processing is somewhere around 50MB/s.</li></ul><p>Image complexity <code>cplx</code> of an image <code>i</code> is:</p><ul><li>For a <a href="I/index.html#imgprims">primitive</a> <code>i</code>, <code>cplx i = 1</code>.</li><li>For a <a href="I/index.html#imgcomp">composition</a> operator <code>op</code>, <code>cplx (op i1 i2) = 1 + cplx i1 + cplx i2</code>.</li><li>For a <a href="I/index.html#imgcomp">crop</a> <code>cr</code>, <code>cplx (cr i1) = 1 + cplx i1 - k</code>, where <code>k</code> is the combined complexity of all the <em>maximal</em> sub-terms that do not contribute to the output.</li></ul><p>For example (assuming an image <code>i</code>):</p><pre><code>let img1 = I.((i &lt;|&gt; i) &lt;-&gt; (i &lt;|&gt; i))
let img2 = I.(let x = i &lt;|&gt; i in x &lt;-&gt; x)
let img3 = I.(((i &lt;|&gt; i) &lt;|&gt; i) &lt;|&gt; i)</code></pre><p>Complexity of each of these is <code>4 * cplx i + 3</code>. This might be surprising for <code>img2</code>.</p><p>If <code>width i = 1</code>, <code>cplx (hcrop 1 0 img1) = 3 + 2 * cplx i</code>, and <code>cplx (hcrop 2 0 img3) = 2 + 2 * cplx i</code>.</p><p>While <code>Notty</code> strives to be accommodating to all usage scenarios, these are the things to keep in mind if the rendering becomes slow:</p><ol><li><p>Image composition is cheap.</p><p>Combining images performs a negligible amount of computation.</p><p>Constructing primitive images that contain scalar values outside of the ASCII range does a little more work upfront and is worth holding onto.</p></li><li><p><a href="Render/index.html">Rendering</a> depends on image complexity.</p><p>As a consequence, this real-world example of wrapping renders in time O(n<sup>2</sup>) in the number of lines:</p><pre><code>let wrap1 width img =
  let rec go img = img ::
    if I.width img &gt; width then go (I.hcrop width 0 img) else []
  in go img |&gt; I.vcat |&gt; I.hsnap ~align:`Left width</code></pre><p>Although <code>crop</code> is applied only <code>lines</code> times, the image complexity of each line depends on the number of preceding lines.</p><p>An O(n) version does not iterate <code>crop</code>:</p><pre><code>let wrap2 width img =
  let rec go off = I.hcrop off 0 img ::
    if I.width img - off &gt; width then go (off + width) else []
  in go 0 |&gt; I.vcat |&gt; I.hsnap ~align:`Left width</code></pre></li><li><p>Rendering depends on the <em>output</em> dimensions, but not on the <em>image</em> dimensions.</p><p>Rendering an image to <code>w * h</code> implicitly crops it to its leftmost <code>w</code> columns and topmost <code>h</code> rows. While <code>w</code> and <code>h</code> will have an impact on the rendering performance, the complexity of the (cropped) image tends to be more important.</p></li></ol></div></body></html>