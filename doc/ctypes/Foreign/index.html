<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Foreign (ctypes.Foreign)</title><link rel="stylesheet" href="../../_odoc-theme/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.0.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../index.html">ctypes</a> &#x00BB; Foreign</nav><header class="odoc-preamble"><h1>Module <code><span>Foreign</span></code></h1><p>High-level bindings for C functions and values</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec value" id="val-foreign" class="anchored"><a href="#val-foreign" class="anchor"></a><code><span><span class="keyword">val</span> foreign : <span>?abi:<a href="../Libffi_abi/index.html#type-abi">Libffi_abi.abi</a> <span class="arrow">&#45;&gt;</span></span> <span>?from:<a href="../Dl/index.html#type-library">Dl.library</a> <span class="arrow">&#45;&gt;</span></span> <span>?stub:bool <span class="arrow">&#45;&gt;</span></span> <span>?check_errno:bool <span class="arrow">&#45;&gt;</span></span>
<span>?release_runtime_lock:bool <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span>)</span> <a href="../Ctypes/index.html#type-fn">Ctypes.fn</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span></span></code></div><div class="spec-doc"><p><code>foreign name typ</code> exposes the C function of type <code>typ</code> named by <code>name</code> as an OCaml value.</p><p>The argument <code>?from</code>, if supplied, is a library handle returned by <a href="../Dl/index.html#val-dlopen"><code>Dl.dlopen</code></a>.</p><p>The argument <code>?stub</code>, if <code>true</code> (defaults to <code>false</code>), indicates that the function should not raise an exception if <code>name</code> is not found but return an OCaml value that raises an exception when called.</p><p>The value <code>?check_errno</code>, which defaults to <code>false</code>, indicates whether <a href="../../ocaml/Unix/index.html#exception-Unix_error"><code>Unix.Unix_error</code></a> should be raised if the C function modifies <code>errno</code>. Please note that a function that succeeds is allowed to change errno. So use this option with caution.</p><p>The value <code>?release_runtime_lock</code>, which defaults to <code>false</code>, indicates whether the OCaml runtime lock should be released during the call to the C function, allowing other threads to run. If the runtime lock is released then the C function must not access OCaml heap objects, such as arguments passed using <a href="../Ctypes/index.html#val-ocaml_string"><code>Ctypes.ocaml_string</code></a> and <a href="../Ctypes/index.html#val-ocaml_bytes"><code>Ctypes.ocaml_bytes</code></a>, and must not call back into OCaml.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <span class="value">Dl.DL_error</span> <p>if <code>name</code> is not found in <code>?from</code> and <code>?stub</code> is <code>false</code>.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-foreign_value" class="anchored"><a href="#val-foreign_value" class="anchor"></a><code><span><span class="keyword">val</span> foreign_value : <span>?from:<a href="../Dl/index.html#type-library">Dl.library</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="../Ctypes/index.html#type-typ">Ctypes.typ</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="../Ctypes/index.html#type-ptr">Ctypes.ptr</a></span></span></code></div><div class="spec-doc"><p><code>foreign_value name typ</code> exposes the C value of type <code>typ</code> named by <code>name</code> as an OCaml value. The argument <code>?from</code>, if supplied, is a library handle returned by <a href="../Dl/index.html#val-dlopen"><code>Dl.dlopen</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-funptr" class="anchored"><a href="#val-funptr" class="anchor"></a><code><span><span class="keyword">val</span> funptr : <span>?abi:<a href="../Libffi_abi/index.html#type-abi">Libffi_abi.abi</a> <span class="arrow">&#45;&gt;</span></span> <span>?name:string <span class="arrow">&#45;&gt;</span></span> <span>?check_errno:bool <span class="arrow">&#45;&gt;</span></span> <span>?runtime_lock:bool <span class="arrow">&#45;&gt;</span></span>
<span>?thread_registration:bool <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span>)</span> <a href="../Ctypes/index.html#type-fn">Ctypes.fn</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span>)</span> <a href="../Ctypes/index.html#type-typ">Ctypes.typ</a></span></span></code></div><div class="spec-doc"><p>Construct a function pointer type from a function type.</p><p>The ctypes library, like C itself, distinguishes functions and function pointers. Functions are not first class: it is not possible to use them as arguments or return values of calls, or store them in addressable memory. Function pointers are first class, and so have none of these restrictions.</p><p>The value <code>?check_errno</code>, which defaults to <code>false</code>, indicates whether <a href="../../ocaml/Unix/index.html#exception-Unix_error"><code>Unix.Unix_error</code></a> should be raised if the C function modifies <code>errno</code>.</p><p>The value <code>?runtime_lock</code>, which defaults to <code>false</code>, indicates whether the OCaml runtime lock should be released during the call to the C function, allowing other threads to run. If the runtime lock is released then the C function must not access OCaml heap objects, such as arguments passed using <a href="../Ctypes/index.html#val-ocaml_string"><code>Ctypes.ocaml_string</code></a> and <a href="../Ctypes/index.html#val-ocaml_bytes"><code>Ctypes.ocaml_bytes</code></a>, and must not call back into OCaml. If the function pointer is used to call into OCaml from C then the <code>?runtime_lock</code> argument indicates whether the lock should be acquired and held during the call.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <span class="value">Dl.DL_error</span> <p>if <code>name</code> is not found in <code>?from</code> and <code>?stub</code> is <code>false</code>.</p><p>A note on lifetime: this function ties the lifetime of the C function to the associated OCaml closure, so that the C function may be used only while the closure is still live.</p><p>The <code>dynamic_funptr</code> function is an alternative to <code>funptr</code> with explicit lifetime management.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-funptr_opt" class="anchored"><a href="#val-funptr_opt" class="anchor"></a><code><span><span class="keyword">val</span> funptr_opt : <span>?abi:<a href="../Libffi_abi/index.html#type-abi">Libffi_abi.abi</a> <span class="arrow">&#45;&gt;</span></span> <span>?name:string <span class="arrow">&#45;&gt;</span></span> <span>?check_errno:bool <span class="arrow">&#45;&gt;</span></span> <span>?runtime_lock:bool <span class="arrow">&#45;&gt;</span></span>
<span>?thread_registration:bool <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span>)</span> <a href="../Ctypes/index.html#type-fn">Ctypes.fn</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span>)</span> option</span> <a href="../Ctypes/index.html#type-typ">Ctypes.typ</a></span></span></code></div><div class="spec-doc"><p>Construct a function pointer type from a function type.</p><p>This behaves like <a href="#val-funptr"><code>funptr</code></a>, except that null pointers appear in OCaml as <code>None</code>.</p></div></div><div class="odoc-spec"><div class="spec exception" id="exception-CallToExpiredClosure" class="anchored"><a href="#exception-CallToExpiredClosure" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">CallToExpiredClosure</span></span></code></div><div class="spec-doc"><p>A closure passed to C was collected by the OCaml garbage collector before it was called.</p></div></div><div class="odoc-spec"><div class="spec module-type" id="module-type-Funptr" class="anchored"><a href="#module-type-Funptr" class="anchor"></a><code><span><span class="keyword">module</span> <span class="keyword">type</span> </span><span><a href="module-type-Funptr/index.html">Funptr</a></span><span> = <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-dynamic_funptr" class="anchored"><a href="#val-dynamic_funptr" class="anchor"></a><code><span><span class="keyword">val</span> dynamic_funptr : <span>?abi:<a href="../Libffi_abi/index.html#type-abi">Libffi_abi.abi</a> <span class="arrow">&#45;&gt;</span></span> <span>?runtime_lock:bool <span class="arrow">&#45;&gt;</span></span> <span>?thread_registration:bool <span class="arrow">&#45;&gt;</span></span>
<span><span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span>)</span> <a href="../Ctypes/index.html#type-fn">Ctypes.fn</a></span> <span class="arrow">&#45;&gt;</span></span> <span>(<span class="keyword">module</span> <a href="module-type-Funptr/index.html">Funptr</a> <span class="keyword">with</span> <span class="keyword">type</span> <a href="module-type-Funptr/index.html#type-fn">fn</a> = <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span>)</span></span></code></div><div class="spec-doc"><p>Define a type representation for passing OCaml functions to C with explicit lifetime management.</p><p><code>(val (dynamic_funptr (foo @-&gt; returning bar)))</code> corresponds to the C type <code>bar( * )(foo)</code>.</p><p>Example:</p><pre><code>module Progress_callback =
  (val (dynamic_funptr (int @-&gt; int @-&gt; ptr void @-&gt; returning void)))
let keygen = foreign &quot;RSA_generate_key&quot;
  (int @-&gt; int @-&gt; Progress_callback.t @-&gt; ptr void @-&gt; returning rsa_key)
let secret_key =
  Progress_callback.with_fun
    (fun a b _ -&gt; printf &quot;progress: a:%d, b:%d\n&quot; a b)
    (fun progress -&gt;
       keygen 2048 65537 progress null)</code></pre></div></div><div class="odoc-spec"><div class="spec value" id="val-report_leaked_funptr" class="anchored"><a href="#val-report_leaked_funptr" class="anchor"></a><code><span><span class="keyword">val</span> report_leaked_funptr : <span><span>(<span>string <span class="arrow">&#45;&gt;</span></span> unit)</span> <a href="../../ocaml/Stdlib/index.html#type-ref">ref</a></span></span></code></div><div class="spec-doc"><p>Hook called on collection of closures associated with <a href="#val-dynamic_funptr"><code>dynamic_funptr</code></a> values that have not been deallocated with <code>free</code>.</p><p>By default the ctypes library retains closures associated with function pointers that have not been freed and prints a warning to stderr.</p><p>You can use this hook to change how these error messages are reported.</p></div></div></div></body></html>