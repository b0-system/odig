<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Op_cache (b0.B00.Op_cache)</title><link rel="stylesheet" href="../../../_odoc-theme/odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../../index.html">b0</a> &#x00BB; <a href="../index.html">B00</a> &#x00BB; Op_cache</nav><h1>Module <code>B00.Op_cache</code></h1><p>Operation cache.</p><p>An operation cache combines a <a href="../File_cache/index.html"><span>file cache</span></a> and a <a href="../../B0_std/Hash/module-type-T/index.html"><span>hash function</span></a> to memoize <a href="../Op/index.html"><span>build operations</span></a>.</p><p><b>Note.</b> File hashes performed by this module are <a href="index.html#val-file_hashes"><span>cached</span></a>.</p><nav class="toc"><ul><li><a href="#cache">Build operation cache</a></li></ul></nav></header><section><header><h2 id="cache"><a href="#cache" class="anchor"></a>Build operation cache</h2></header><dl><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> t</code></dt><dd><p>The type for build operation caches.</p></dd></dl><dl><dt class="spec value" id="val-create"><a href="#val-create" class="anchor"></a><code><span class="keyword">val</span> create : ?&#8288;clock:<a href="../../B0_std/Time/index.html#type-counter">B0_std.Time.counter</a> <span>&#45;&gt;</span> ?&#8288;hash_fun:(<span class="keyword">module</span> <a href="../../B0_std/Hash/module-type-T/index.html">B0_std.Hash.T</a>) <span>&#45;&gt;</span> <a href="../File_cache/index.html#type-t">File_cache.t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></dt><dd><p><code>create ~clock ~hash_fun c</code> is an operation cache with</p><ul><li><code>c</code> the file cache used to memoize build operations</li><li><code>hash_fun</code> the hash function used to hash files and build operations; defaults to <a href="../../B0_std/Hash/Xxh_64/index.html"><code>B0_std.Hash.Xxh_64</code></a></li><li><code>clock</code> the clock used to <a href="index.html#val-file_hash_dur"><span>measure</span></a> file hashing time and <a href="../Op/index.html#val-set_exec_start_time"><span>timestamp</span></a> revived operations defaults to <a href="../../B0_std/Time/index.html#type-counter"><code>B0_std.Time.counter</code></a><code> ()</code>.</li></ul></dd></dl><dl><dt class="spec value" id="val-set_op_hash"><a href="#val-set_op_hash" class="anchor"></a><code><span class="keyword">val</span> set_op_hash : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../Op/index.html#type-t">Op.t</a> <span>&#45;&gt;</span> (unit, string) <a href="../../../ocaml/Stdlib/index.html#type-result">Stdlib.result</a></code></dt><dd><p><code>set_op_hash t o</code> hashes the operation <code>o</code> and stores the result in <code>o</code> with <a href="../Op/index.html#val-set_hash"><code>Op.set_hash</code></a>. Errors if an input file of the operation can't be hashed.</p></dd></dl><dl><dt class="spec value" id="val-revive"><a href="#val-revive" class="anchor"></a><code><span class="keyword">val</span> revive : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../Op/index.html#type-t">Op.t</a> <span>&#45;&gt;</span> (<a href="../../B0_std/Fpath/index.html#type-t">B0_std.Fpath.t</a> list option, string) <a href="../../../ocaml/Stdlib/index.html#type-result">Stdlib.result</a></code></dt><dd><p><code>revive c o</code> tries to revive operation <code>o</code> from the file cache using the key <code>Op.hash o</code>. In particular this:</p><ol><li>Recreates the files <code>Op.writes o</code></li><li>Sets <code>o</code>'s execution information using the metadata hunk of the key. For example for spawn operations this also recovers the <span class="xref-unresolved" title="unresolved reference to &quot;Op.Spawn.exit&quot;"><span>exit status</span></span> code and <a href="../Op/Spawn/index.html#val-stdo_ui"><span>standard output redirection contents</span></a> into <code>o</code>.</li></ol><p>The semantics of the result is like <a href="../File_cache/index.html#val-revive"><code>File_cache.revive</code></a>; in particular in case of <code>Ok None</code> the key nothing was revived.</p><p><b>Warning.</b> In any case the fields <a href="../Op/index.html#val-exec_start_time"><code>Op.exec_start_time</code></a>, <a href="../Op/index.html#val-exec_end_time"><code>Op.exec_end_time</code></a> and <span class="xref-unresolved" title="unresolved reference to &quot;Op.exec_status&quot;"><a href="../index.html#module-Op"><code>Op</code></a>.exec_status</span> of <code>o</code> get set.</p></dd></dl><dl><dt class="spec value" id="val-add"><a href="#val-add" class="anchor"></a><code><span class="keyword">val</span> add : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../Op/index.html#type-t">Op.t</a> <span>&#45;&gt;</span> (bool, string) <a href="../../../ocaml/Stdlib/index.html#type-result">Stdlib.result</a></code></dt><dd><p><code>add c o</code> adds operation <code>o</code> to the cache. This associates the <code>Op.writes o</code> of <code>o</code> to the key <code>Op.hash o</code> and stores execution information of <code>o</code> in the key's metadata hunk. The semantics of the result is like <a href="../File_cache/index.html#val-add"><code>File_cache.add</code></a>; in particular in case of <code>Ok false</code> it means some file in the set of writes do not exist and is likely an error.</p></dd></dl><dl><dt class="spec value" id="val-hash_fun"><a href="#val-hash_fun" class="anchor"></a><code><span class="keyword">val</span> hash_fun : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> (<span class="keyword">module</span> <a href="../../B0_std/Hash/module-type-T/index.html">B0_std.Hash.T</a>)</code></dt><dd><p><code>hash_fun c</code> is the hash function used by the operation cache.</p></dd></dl><dl><dt class="spec value" id="val-file_hashes"><a href="#val-file_hashes" class="anchor"></a><code><span class="keyword">val</span> file_hashes : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../B0_std/Hash/index.html#type-t">B0_std.Hash.t</a> <a href="../../B0_std/Fpath/Map/index.html#type-t">B0_std.Fpath.Map.t</a></code></dt><dd><p><code>file_hashes c</code> is a map of the files that were hashed.</p></dd></dl><dl><dt class="spec value" id="val-file_hash_dur"><a href="#val-file_hash_dur" class="anchor"></a><code><span class="keyword">val</span> file_hash_dur : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../B0_std/Time/index.html#type-span">B0_std.Time.span</a></code></dt><dd><p><code>file_hash_dur c</code> is the time spent hashing files.</p></dd></dl></section></div></body></html>