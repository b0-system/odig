<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Ocb_stubblr (ocb-stubblr.Ocb_stubblr)</title><link rel="stylesheet" href="../../_odoc-theme/odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../index.html">ocb-stubblr</a> &#x00BB; Ocb_stubblr</nav><h1>Module <code>Ocb_stubblr</code></h1><p>OCamlbuild plugin for C stubs</p><p>See the <a href="index.html#intro"><span>Intro</span></a>, <a href="index.html#interface"><span>Interface</span></a> or <a href="index.html#examples"><span>Examples</span></a>.</p><nav class="toc"><ul><li><a href="#intro">Intro</a><ul><li><a href="#1.-using-.clib-files">1. Using <code>.clib</code> files</a></li><li><a href="#2.-pkg-config">2. <code>pkg-config</code></a></li><li><a href="#multilib">3. Multi-lib</a></li></ul></li><li><a href="#interface">Interface</a><ul><li><a href="#utilities">Utilities</a></li><li><a href="#os-and-machine-detection">OS and machine detection</a></li></ul></li><li><a href="#examples">Examples</a><ul><li><a href="#basic-integration">Basic integration</a></li><li><a href="#pkg-config"><code>pkg-config</code></a></li><li><a href="#in-tree-executables">In-tree executables</a></li><li><a href="#multi-lib">Multi-lib</a></li><li><a href="#mirage">Mirage</a></li><li><a href="#composition">Composition</a></li></ul></li></ul></nav></header><section><header><h2 id="intro"><a href="#intro" class="anchor"></a>Intro</h2><p><code>ocb-stubblr</code> helps dealing with C libraries that are built as part of an OCaml project. It is especially useful for libraries of OCaml primitives (stubs).</p><p>Most of the plugin consists of new tags that can be applied to files, and new rules that are activated when OCamlbuild tries to build certain targets. In order to enable these, <a href="index.html#val-init"><code>init</code></a> needs to be called from <a href="../../ocamlbuild/Ocamlbuild_plugin/index.html#val-dispatch"><code>Ocamlbuild_plugin.dispatch</code></a>:</p><pre><code class="ml">let () = Ocamlbuild_plugin.dispatch Ocb_stubblr.init</code></pre><p>The plugin helps with three aspects of building C stubs:</p></header><section><header><h3 id="1.-using-.clib-files"><a href="#1.-using-.clib-files" class="anchor"></a>1. Using <code>.clib</code> files</h3><p><code>stubblr</code> modifies <code>.clib</code> build rules to automatically search for, and require, project-local headers that the C source files <code>#include</code>.</p><p>Furthermore, it provides the tag <code>link_stubs()</code>. This tag acts on OCaml archives, and records the link flags needed for linking with the given C library. The parameter is assumed to be a <code>.clib</code> file in the same project.</p><p>For example, adding</p><pre><code class="ml">&lt;foo.cm{,x}a&gt;: link_stubs(path/libbar)</code></pre><p>records the link flag <code>-lbar</code> in <code>foo.cm{,x}a</code>. Assuming that the C libraries described by <code>path/libbar.clib</code> are installed, this causes any final executables that use the archive <code>foo.cmxa</code> (resp. <code>foo.cma</code>) to link to <code>libbar.a</code> (resp <code>dllbar.so</code>). This is useful if <code>Foo</code> provides the interface to the C primitives in <code>libbar</code>.</p><p>Another feature is the automatic addition of <code>use_&lt;lib&gt;</code> tags for every <code>&lt;lib&gt;.mllib</code>. OCaml sources tagged with this tag are built against the archive <code>&lt;lib&gt;.cm{,x}a</code>, instead of using its constituent <code>cm{o,x}</code> through <code>include</code> tags. This means that the in-tree executables inherit the link flags (as introduced, for example, above), and are correctly linked against the in-tree C libraries.</p><p>Finally, the tags <code>ccopt</code> and <code>cclib</code>, which were introduced in OCamlbuild 0.9.3, are added if the plugin is used with an older version. This allows setting these options directly from <code>_tags</code> with any OCamlbuild version.</p></header></section><section><header><h3 id="2.-pkg-config"><a href="#2.-pkg-config" class="anchor"></a>2. <code>pkg-config</code></h3><p><code>stubblr</code> provides the tag <code>pkg-config()</code>.</p><p>Tagging objects with <code>pkg-config(package)</code> will query <code>pkg-config</code> for the <code>package</code>, and:</p><ol><li>add the C flags (<code>pkg-config --cflags</code>) to the compilation of tagged C sources;</li><li>add the link flags (<code>pkg-config --libs</code>) to the linking step of tagged C libraries; and</li><li>record those link flags in the tagged OCaml archives.</li></ol><p>For example</p><pre><code class="ml">&lt;src/*.{c,cma,cmxa}&gt;: pkg-config(sdl2)</code></pre><p>will add the flags needed to compile against SDL2 when compiling C sources, and record the flags needed to link the final executables against <code>libSDL2.so</code> to the native and bytecode archives.</p><p>The full syntax of the tag is <code>pkg-config(package[ relax][ &lt;params&gt;])</code> where <code>&lt;params&gt;</code> is a space-separated combination of any of: <code>cflags</code>, <code>libs</code>, <code>static</code>.</p><p><code>relax</code> will ignore the package if it is not found. Otherwise, the build will abort.</p><p><code>cflags</code> will query <code>--cflags</code>.</p><p><code>libs</code> will query <code>--libs</code>.</p><p><code>static</code> will query <code>--libs --static</code> (and has precedence over <code>libs</code>).</p><p>If none of <code>cflags</code>, <code>libs</code> and <code>static</code> are present, <code>cflags libs</code> is assumed. Thus <code>pkg-config(pkg relax)</code> will query <code>--cflags</code> and <code>--libs</code>, and ignore the error if <code>pkg</code> is not installed; <code>pkg-config(pkg cflags)</code> will query only the <code>--cflags</code>; while <code>pkg-config(pkg static)</code> will query only <code>--libs --static</code>.</p><p><b>Note</b> <code>.pc</code> files in the current Opam switch take precedence; see <a href="Pkg_config/index.html"><span><code>Pkg_config</code></span></a>.</p></header></section><section><header><h3 id="multilib"><a href="#multilib" class="anchor"></a>3. Multi-lib</h3><p>Sometimes it can be desirable to compile a C library in several ways, e.g. with different compilation options, and install all of the versions.</p><p>For any file <code>path/libstub.clib</code>, <code>stubblr</code> introduces the rules to build <code>X/&lt;TARGET&gt;/path/libstub+&lt;TARGET&gt;.clib</code>, where <code>&lt;TARGET&gt;</code> is an arbitrary name. The new library is built from the same sources, but it doesn't inherit any of the tags directly applied to the original <code>.clib</code> and its products. Instead, the files <code>X/&lt;TARGET&gt;/**/*</code> can be marked with a separate set of tags, causing them to be compiled and/or linked with different options.</p><p>As a special case, there are pre-defined targets for different MirageOS runtimes (currently <code>mirage-xen</code> and <code>mirage-freestanding</code>). These are automatically tagged with the required compilation options.</p><p><b>Note</b> If your paths already contain <code>+</code>, OCamlbuild solver is likely to get confused. Assume that the meaning of <code>+</code> in paths has been hijacked by <code>ocb-stubblr</code>. The new semantics of <code>+</code> is accessible only through transcendental hermenautics.</p></header></section></section><section><header><h2 id="interface"><a href="#interface" class="anchor"></a>Interface</h2></header><dl><dt class="spec type" id="type-ocb_hook"><a href="#type-ocb_hook" class="anchor"></a><code><span class="keyword">type</span> ocb_hook</code><code> = <a href="../../ocamlbuild/Ocamlbuild_plugin/index.html#type-hook">Ocamlbuild_plugin.hook</a> <span>&#45;&gt;</span> unit</code></dt><dt class="spec type" id="type-path"><a href="#type-path" class="anchor"></a><code><span class="keyword">type</span> path</code><code> = <a href="../../ocamlbuild/Ocamlbuild_plugin/Pathname/index.html#type-t">Ocamlbuild_plugin.Pathname.t</a></code></dt></dl><dl><dt class="spec value" id="val-init"><a href="#val-init" class="anchor"></a><code><span class="keyword">val</span> init : ?&#8288;incdirs:bool <span>&#45;&gt;</span> ?&#8288;mllibs:<a href="index.html#type-path">path</a> list <span>&#45;&gt;</span> <a href="index.html#type-ocb_hook">ocb_hook</a></code></dt><dd><p><code>init ?incdirs ?paths</code> initializes the plugin.</p><p><code>incdirs</code> causes <a href="index.html#val-include_include_dirs"><span><code>include_include_dirs</code></span></a> to be called on initialisation. Defaults to <code>true</code>.</p><p><code>mllibs</code> are passed to <a href="index.html#val-ocaml_libs"><span><code>ocaml_libs</code></span></a>, to detect any <code>&lt;lib&gt;.mllib</code> files and enable their corresponding <code>use_&lt;lib&gt;</code> tags. Use <code>[]</code> to disable. Defaults to <code>[&quot;.&quot;]</code>.</p></dd></dl><section><header><h3 id="utilities"><a href="#utilities" class="anchor"></a>Utilities</h3></header><dl><dt class="spec value" id="val-ocaml_libs"><a href="#val-ocaml_libs" class="anchor"></a><code><span class="keyword">val</span> ocaml_libs : ?&#8288;mllibs:<a href="index.html#type-path">path</a> list <span>&#45;&gt;</span> <a href="index.html#type-ocb_hook">ocb_hook</a></code></dt><dd><p><code>ocaml_libs ~mllibs</code> calls <a href="../../ocamlbuild/Ocamlbuild_plugin/index.html#val-ocaml_lib"><code>Ocamlbuild_plugin.ocaml_lib</code></a> on every <code>.mllib</code> found in <code>mllibs</code>. It's a shortcut to enable <code>use_&lt;lib&gt;</code> tag for every <code>&lt;lib&gt;.mllib</code> in the project.</p><p><code>mllibs</code> is a list of files or directories. Directories in the list are searched recursively. <code>mllibs</code> defaults to <code>[&quot;.&quot;]</code>.</p></dd></dl><dl><dt class="spec value" id="val-include_include_dirs"><a href="#val-include_include_dirs" class="anchor"></a><code><span class="keyword">val</span> include_include_dirs : <a href="index.html#type-ocb_hook">ocb_hook</a></code></dt><dd><p><code>include_include_dirs</code> will add <code>-I dir</code> when linking OCaml programs and <code>cmxs</code> for every <code>dir</code> marked as <code>include</code>.</p></dd></dl><dl><dt class="spec value" id="val-ccopt"><a href="#val-ccopt" class="anchor"></a><code><span class="keyword">val</span> ccopt : ?&#8288;tags:string list <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <a href="index.html#type-ocb_hook">ocb_hook</a></code></dt><dd><p><code>ccopt tags options</code> adds <code>-ccopt options</code> when compiling the C sources tagged with <code>~tags</code>.</p><p><code>tags</code> defaults to <code>[]</code>.</p></dd></dl><dl><dt class="spec value" id="val-cclib"><a href="#val-cclib" class="anchor"></a><code><span class="keyword">val</span> cclib : ?&#8288;tags:string list <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <a href="index.html#type-ocb_hook">ocb_hook</a></code></dt><dd><p><code>cclib tags options</code> adds <code>-cclib options</code> when linking the C libraries tagged with <code>~tags</code>.</p><p><code>tags</code> defaults to <code>[]</code>.</p></dd></dl><dl><dt class="spec value" id="val-ldopt"><a href="#val-ldopt" class="anchor"></a><code><span class="keyword">val</span> ldopt : ?&#8288;tags:string list <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <a href="index.html#type-ocb_hook">ocb_hook</a></code></dt><dd><p><code>ldopt tags options</code> adds <code>-ldopt options</code> when linking the C libraries tagged with <code>~tags</code>.</p><p><code>tags</code> defaults to <code>[]</code>.</p></dd></dl><dl><dt class="spec value" id="val-after_rules"><a href="#val-after_rules" class="anchor"></a><code><span class="keyword">val</span> after_rules : (unit <span>&#45;&gt;</span> unit) <span>&#45;&gt;</span> <a href="index.html#type-ocb_hook">ocb_hook</a></code></dt><dd><p><code>after_rules f</code> is <code>function After_rules -&gt; f () | _ -&gt; ()</code>.</p></dd></dl><dl><dt class="spec value" id="val-dispatchv"><a href="#val-dispatchv" class="anchor"></a><code><span class="keyword">val</span> dispatchv : <a href="index.html#type-ocb_hook">ocb_hook</a> list <span>&#45;&gt;</span> unit</code></dt><dd><p><code>dispatchv hooks</code> is a shortcut for registering several <a href="index.html#type-ocb_hook"><span>ocb_hooks</span></a>.</p><p>It is equivalent to <code>Ocamlbuild_plugin.dispatch hookf</code> where <code>hookf</code> is a function that applies each hook from <code>hooks</code> in order.</p></dd></dl><dl><dt class="spec value" id="val-(&amp;)"><a href="#val-(&amp;)" class="anchor"></a><code><span class="keyword">val</span> (&amp;) : <a href="index.html#type-ocb_hook">ocb_hook</a> <span>&#45;&gt;</span> <a href="index.html#type-ocb_hook">ocb_hook</a> <span>&#45;&gt;</span> <a href="index.html#type-ocb_hook">ocb_hook</a></code></dt><dd><p><code>h1 &amp; h2</code> is a hook combining <code>h1</code> and <code>h2</code>.</p></dd></dl><dl><dt class="spec module" id="module-Pkg_config"><a href="#module-Pkg_config" class="anchor"></a><code><span class="keyword">module</span> <a href="Pkg_config/index.html">Pkg_config</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>Query <code>pkg-config</code>.</p></dd></dl></section><section><header><h3 id="os-and-machine-detection"><a href="#os-and-machine-detection" class="anchor"></a>OS and machine detection</h3><p>These utilities are included because it is sometimes necessary to change options for building C libraries depending on the host OS and architecture.</p></header><dl><dt class="spec type" id="type-os"><a href="#type-os" class="anchor"></a><code><span class="keyword">type</span> os</code> = <code>[ </code><table class="variant"><tr id="type-os.Linux" class="anchored"><td class="def constructor"><a href="#type-os.Linux" class="anchor"></a><code>| </code><code>`Linux</code></td></tr><tr id="type-os.Hurd" class="anchored"><td class="def constructor"><a href="#type-os.Hurd" class="anchor"></a><code>| </code><code>`Hurd</code></td></tr><tr id="type-os.Darwin" class="anchored"><td class="def constructor"><a href="#type-os.Darwin" class="anchor"></a><code>| </code><code>`Darwin</code></td></tr><tr id="type-os.FreeBSD" class="anchored"><td class="def constructor"><a href="#type-os.FreeBSD" class="anchor"></a><code>| </code><code>`FreeBSD</code></td></tr><tr id="type-os.OpenBSD" class="anchored"><td class="def constructor"><a href="#type-os.OpenBSD" class="anchor"></a><code>| </code><code>`OpenBSD</code></td></tr><tr id="type-os.NetBSD" class="anchored"><td class="def constructor"><a href="#type-os.NetBSD" class="anchor"></a><code>| </code><code>`NetBSD</code></td></tr><tr id="type-os.DragonFly" class="anchored"><td class="def constructor"><a href="#type-os.DragonFly" class="anchor"></a><code>| </code><code>`DragonFly</code></td></tr><tr id="type-os.KFreeBSD" class="anchored"><td class="def constructor"><a href="#type-os.KFreeBSD" class="anchor"></a><code>| </code><code>`KFreeBSD</code></td></tr><tr id="type-os.Haiku" class="anchored"><td class="def constructor"><a href="#type-os.Haiku" class="anchor"></a><code>| </code><code>`Haiku</code></td></tr><tr id="type-os.HP_UX" class="anchored"><td class="def constructor"><a href="#type-os.HP_UX" class="anchor"></a><code>| </code><code>`HP_UX</code></td></tr><tr id="type-os.AIX" class="anchored"><td class="def constructor"><a href="#type-os.AIX" class="anchor"></a><code>| </code><code>`AIX</code></td></tr><tr id="type-os.Interix" class="anchored"><td class="def constructor"><a href="#type-os.Interix" class="anchor"></a><code>| </code><code>`Interix</code></td></tr><tr id="type-os.Minix" class="anchored"><td class="def constructor"><a href="#type-os.Minix" class="anchor"></a><code>| </code><code>`Minix</code></td></tr><tr id="type-os.QNX" class="anchored"><td class="def constructor"><a href="#type-os.QNX" class="anchor"></a><code>| </code><code>`QNX</code></td></tr><tr id="type-os.SunOS" class="anchored"><td class="def constructor"><a href="#type-os.SunOS" class="anchor"></a><code>| </code><code>`SunOS</code></td></tr><tr id="type-os.Cygwin" class="anchored"><td class="def constructor"><a href="#type-os.Cygwin" class="anchor"></a><code>| </code><code>`Cygwin <span class="keyword">of</span> string</code></td></tr><tr id="type-os.Mingw" class="anchored"><td class="def constructor"><a href="#type-os.Mingw" class="anchor"></a><code>| </code><code>`Mingw <span class="keyword">of</span> string</code></td></tr><tr id="type-os.Uwin" class="anchored"><td class="def constructor"><a href="#type-os.Uwin" class="anchor"></a><code>| </code><code>`Uwin <span class="keyword">of</span> string</code></td></tr><tr id="type-os.UNKNOWN" class="anchored"><td class="def constructor"><a href="#type-os.UNKNOWN" class="anchor"></a><code>| </code><code>`UNKNOWN <span class="keyword">of</span> string</code></td></tr></table><code> ]</code></dt><dd><p>A selection of popular operating systems.</p></dd></dl><dl><dt class="spec type" id="type-machine"><a href="#type-machine" class="anchor"></a><code><span class="keyword">type</span> machine</code> = <code>[ </code><table class="variant"><tr id="type-machine.x86_64" class="anchored"><td class="def constructor"><a href="#type-machine.x86_64" class="anchor"></a><code>| </code><code>`x86_64</code></td></tr><tr id="type-machine.x86" class="anchored"><td class="def constructor"><a href="#type-machine.x86" class="anchor"></a><code>| </code><code>`x86</code></td></tr><tr id="type-machine.ARMv6" class="anchored"><td class="def constructor"><a href="#type-machine.ARMv6" class="anchor"></a><code>| </code><code>`ARMv6</code></td></tr><tr id="type-machine.ARMv7" class="anchored"><td class="def constructor"><a href="#type-machine.ARMv7" class="anchor"></a><code>| </code><code>`ARMv7</code></td></tr><tr id="type-machine.UNKNOWN" class="anchored"><td class="def constructor"><a href="#type-machine.UNKNOWN" class="anchor"></a><code>| </code><code>`UNKNOWN <span class="keyword">of</span> string</code></td></tr></table><code> ]</code></dt><dd><p>A selection of machine architectures supported by OCaml.</p></dd></dl><dl><dt class="spec value" id="val-os"><a href="#val-os" class="anchor"></a><code><span class="keyword">val</span> os : unit <span>&#45;&gt;</span> <a href="index.html#type-os">os</a></code></dt><dd><p><code>os ()</code> is the normalized result of <code>uname -s</code>.</p></dd></dl><dl><dt class="spec value" id="val-machine"><a href="#val-machine" class="anchor"></a><code><span class="keyword">val</span> machine : unit <span>&#45;&gt;</span> <a href="index.html#type-machine">machine</a></code></dt><dd><p><code>machine ()</code> is the normalized result of <code>uname -m</code>.</p></dd></dl></section></section><section><header><h2 id="examples"><a href="#examples" class="anchor"></a>Examples</h2><p>Assume a project laid out like the following:</p><p>Project dir:</p><pre><code class="ml">./myocamlbuild.ml
./_tags
./src/foo.ml
./src/stubs.c
./src/extra/defs.h
./src/libstubs.clib
./src/foo.mllib
./exe/demo.ml</code></pre><p>The content of <code>src/foo.mllib</code>:</p><pre><code class="ml">Foo</code></pre><p>The content of <code>src/libstubs.clib</code>:</p><pre><code class="ml">stubs.o</code></pre><p>The content of <code>_tags</code>:</p><pre><code class="ml">&lt;src&gt;: include</code></pre></header><section><header><h3 id="basic-integration"><a href="#basic-integration" class="anchor"></a>Basic integration</h3><p>Initialize the plugin from <code>myocamlbuild.ml</code>:</p><pre><code class="ml">let () = Ocamlbuild_plugin.dispatch Ocb_stubblr.init</code></pre><p>The file <code>src/extra/defs.h</code> will be automatically used when compiling <code>src/stubs.c</code>, if needed.</p><p>Adding the tag</p><pre><code class="ml">&lt;src/*.cm{,x}a&gt;: link_stubs(src/libstubs)</code></pre><p>will record the link flag <code>-lstubs</code> in <code>foo.cm{,x}a</code>, causing executables that use them to link against <code>libstubs.a</code>/<code>dllstubs.so</code>.</p></header></section><section><header><h3 id="pkg-config"><a href="#pkg-config" class="anchor"></a><code>pkg-config</code></h3><p>Adding the tag</p><pre><code class="ml">&lt;src/*.{c,cma,cmxa}&gt;: pkg-config(sdl2 relax)</code></pre><p>will cause <code>stubs.c</code> to be compiled with C flags from <code>sdl2.pc</code>, and <code>foo.cm{,x}a</code> to record the link flags.</p><p>If <code>SDL2</code> is not installed, <code>relax</code> will cause it to be ignored.</p></header></section><section><header><h3 id="in-tree-executables"><a href="#in-tree-executables" class="anchor"></a>In-tree executables</h3><p>To build <code>demo.native</code> and/or <code>demo.byte</code>, <code>_tags</code> needs to contain</p><pre><code class="ml">&lt;exe/*&gt;: use_foo</code></pre><p>causing <code>demo.{native,byte}</code> to build against <code>foo.cm{,x}a</code> and inherit its link flags. The archive, in turn, contains flags for linking to the stub library (<code>link_stubs()</code>), and linking to <code>SDL2</code> (<code>pkg-config()</code>).</p></header></section><section><header><h3 id="multi-lib"><a href="#multi-lib" class="anchor"></a>Multi-lib</h3><p>Invoking <code>ocamlbuild X/fnord/src/libstubs+fnord.a</code> will build <code>libstubs+fnord.a</code>.</p><p>If <code>_tags</code> contains</p><pre><code class="ml">&lt;src/*.c&gt;: ccopt(-flub)
&lt;X/fnord/**/*.c&gt;: ccopt(-DA)</code></pre><p>then <code>libstubs+fnord.a</code> will <em>not</em> be compiled with <code>-flub</code>. Instead, it will be compiled with the pre-processor symbol <code>A</code> defined.</p></header></section><section><header><h3 id="mirage"><a href="#mirage" class="anchor"></a>Mirage</h3><p>If using <code>Topkg</code>, register the <code>.clib</code> file using <span class="xref-unresolved" title="unresolved reference to &quot;Ocb_stubblr_topkg.mirage&quot;"><code>Ocb_stubblr_topkg</code>.mirage</span>.</p><pre><code class="ml">Pkg.describe ... @ fun c -&gt;
  ...
  Ok [ Pkg.clib &quot;path/to/libstubs.clib&quot;;
       Ocb_stubblr_topkg.mirage &quot;path/to/libstubs.clib&quot;]</code></pre><p>Otherwise, arrange for building and installation of <code>X/&lt;TARGET&gt;/path/to/libstubs+&lt;TARGET&gt;.a</code> for all MirageOS <code>TARGET</code>s.</p><p>Use of these alternate archives is a matter of MirageOS.</p></header></section><section><header><h3 id="composition"><a href="#composition" class="anchor"></a>Composition</h3><pre><code class="ml">let myhook = function
  | After_rules -&gt; ...
  | ...</code></pre><pre><code class="ml">let () = Ocb_stubblr.(dispatchv [init; myhook])</code></pre><pre><code class="ml">let () = dispatch Ocb_stubblr.(init &amp; myhook)</code></pre></header></section></section></div></body></html>