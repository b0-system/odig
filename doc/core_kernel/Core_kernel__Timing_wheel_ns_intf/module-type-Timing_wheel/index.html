<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Timing_wheel (core_kernel.Core_kernel__Timing_wheel_ns_intf.Timing_wheel)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../../index.html">core_kernel</a> &#x00BB; <a href="../index.html">Core_kernel__Timing_wheel_ns_intf</a> &#x00BB; Timing_wheel</nav><h1>Module type <code>Core_kernel__Timing_wheel_ns_intf.Timing_wheel</code></h1></header><div class="spec module" id="module-Time"><a href="#module-Time" class="anchor"></a><code><span class="keyword">module </span><a href="Time/index.html">Time</a> : <a href="../index.html#module-type-Timing_wheel_time">Timing_wheel_time</a></code></div><div class="spec module" id="module-Alarm_precision"><a href="#module-Alarm_precision" class="anchor"></a><code><span class="keyword">module </span><a href="Alarm_precision/index.html">Alarm_precision</a> : <a href="../index.html#module-type-Alarm_precision">Alarm_precision</a><span class="keyword"> with </span><span class="keyword">module </span><a href="../module-type-Alarm_precision/Time/index.html">Time</a> := <a href="index.html#module-Time">Time</a></code></div><dl><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type </span>'a t</code></dt></dl><div><div class="spec include"><div class="doc"><details open="open"><summary><span class="def"><code><span class="keyword">include </span><span class="keyword">sig</span> ... <span class="keyword">end</span></code></span></summary><dl><dt class="spec value" id="val-sexp_of_t"><a href="#val-sexp_of_t" class="anchor"></a><code><span class="keyword">val </span>sexp_of_t : (<span class="type-var">'a</span> <span>&#45;&gt;</span> Sexplib.Sexp.t) <span>&#45;&gt;</span> <span class="type-var">'a</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> Sexplib.Sexp.t</code></dt></dl></details></div></div></div><dl><dt class="spec type" id="type-timing_wheel"><a href="#type-timing_wheel" class="anchor"></a><code><span class="keyword">type </span>'a timing_wheel</code><code><span class="keyword"> = </span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></code></dt><dt class="spec type" id="type-t_now"><a href="#type-t_now" class="anchor"></a><code><span class="keyword">type </span>'a t_now</code><code><span class="keyword"> = </span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></code></dt><dd><p><code>&lt;:sexp_of&lt; _ t_now &gt;&gt;</code> displays only <code>now t</code>, not all the alarms.</p></dd></dl><div><div class="spec include"><div class="doc"><details open="open"><summary><span class="def"><code><span class="keyword">include </span><span class="keyword">sig</span> ... <span class="keyword">end</span></code></span></summary><dl><dt class="spec value" id="val-sexp_of_t_now"><a href="#val-sexp_of_t_now" class="anchor"></a><code><span class="keyword">val </span>sexp_of_t_now : (<span class="type-var">'a</span> <span>&#45;&gt;</span> Sexplib.Sexp.t) <span>&#45;&gt;</span> <span class="type-var">'a</span> <a href="index.html#type-t_now">t_now</a> <span>&#45;&gt;</span> Sexplib.Sexp.t</code></dt></dl></details></div></div></div><div class="spec module" id="module-Interval_num"><a href="#module-Interval_num" class="anchor"></a><code><span class="keyword">module </span><a href="Interval_num/index.html">Interval_num</a> : <a href="../index.html#module-type-Interval_num">Interval_num</a></code></div><div class="spec module" id="module-Alarm"><a href="#module-Alarm" class="anchor"></a><code><span class="keyword">module </span><a href="Alarm/index.html">Alarm</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div><div class="spec include"><div class="doc"><details open="open"><summary><span class="def"><code><span class="keyword">include </span>Core_kernel__.Import.Invariant.S1<span class="keyword"> with </span><span class="keyword">type </span>'a <a href="../index.html#module-type-Timing_wheel">Timing_wheel</a>.t := <span class="type-var">'a</span> <a href="index.html#type-t">t</a></code></span></summary><dl><dt class="spec value" id="val-invariant"><a href="#val-invariant" class="anchor"></a><code><span class="keyword">val </span>invariant : <span class="type-var">'a</span> Base__.Invariant_intf.inv <span>&#45;&gt;</span> <span class="type-var">'a</span> <a href="index.html#type-t">t</a> Base__.Invariant_intf.inv</code></dt></dl></details></div></div></div><div class="spec module" id="module-Level_bits"><a href="#module-Level_bits" class="anchor"></a><code><span class="keyword">module </span><a href="Level_bits/index.html">Level_bits</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module" id="module-Config"><a href="#module-Config" class="anchor"></a><code><span class="keyword">module </span><a href="Config/index.html">Config</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><dl><dt class="spec value" id="val-create"><a href="#val-create" class="anchor"></a><code><span class="keyword">val </span>create : config:<a href="Config/index.html#type-t">Config.t</a> <span>&#45;&gt;</span> start:<a href="Time/index.html#type-t">Time.t</a> <span>&#45;&gt;</span> <span class="type-var">'a</span> <a href="index.html#type-t">t</a></code></dt><dd><p><code>create ~config ~start</code> creates a new timing wheel with current time <code>start</code>. <code>create</code> raises if <code>start &lt; Time.epoch</code>. For a fixed <code>level_bits</code>, a smaller (i.e. more precise) <code>alarm_precision</code> decreases the representable range of times/keys and increases the constant factor for <code>advance_clock</code>.</p></dd></dl><dl><dt class="spec value" id="val-alarm_precision"><a href="#val-alarm_precision" class="anchor"></a><code><span class="keyword">val </span>alarm_precision : <span class="type-var">_</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="Time/Span/index.html#type-t">Time.Span.t</a></code></dt><dd><p>Accessors</p></dd></dl><dl><dt class="spec value" id="val-now"><a href="#val-now" class="anchor"></a><code><span class="keyword">val </span>now : <span class="type-var">_</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="Time/index.html#type-t">Time.t</a></code></dt><dt class="spec value" id="val-start"><a href="#val-start" class="anchor"></a><code><span class="keyword">val </span>start : <span class="type-var">_</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="Time/index.html#type-t">Time.t</a></code></dt><dt class="spec value" id="val-is_empty"><a href="#val-is_empty" class="anchor"></a><code><span class="keyword">val </span>is_empty : <span class="type-var">_</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> Core_kernel__.Import.bool</code></dt><dd><p>One can think of a timing wheel as a set of alarms. Here are various container functions along those lines.</p></dd></dl><dl><dt class="spec value" id="val-length"><a href="#val-length" class="anchor"></a><code><span class="keyword">val </span>length : <span class="type-var">_</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> Core_kernel__.Import.int</code></dt><dt class="spec value" id="val-iter"><a href="#val-iter" class="anchor"></a><code><span class="keyword">val </span>iter : <span class="type-var">'a</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> f:(<span class="type-var">'a</span> <a href="Alarm/index.html#type-t">Alarm.t</a> <span>&#45;&gt;</span> Core_kernel__.Import.unit) <span>&#45;&gt;</span> Core_kernel__.Import.unit</code></dt><dt class="spec value" id="val-interval_num"><a href="#val-interval_num" class="anchor"></a><code><span class="keyword">val </span>interval_num : <span class="type-var">_</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="Time/index.html#type-t">Time.t</a> <span>&#45;&gt;</span> <a href="Interval_num/index.html#type-t">Interval_num.t</a></code></dt><dd><p><code>interval_num t time</code> returns the number of the interval that <code>time</code> is in, where <code>0</code> is the interval that starts at <code>Time.epoch</code>. <code>interval_num</code> raises if <code>Time.( &lt;
      ) time Time.epoch</code>.</p><p><code>now_interval_num t</code> equals <code>interval_num t (now t)</code>.</p></dd></dl><dl><dt class="spec value" id="val-now_interval_num"><a href="#val-now_interval_num" class="anchor"></a><code><span class="keyword">val </span>now_interval_num : <span class="type-var">_</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="Interval_num/index.html#type-t">Interval_num.t</a></code></dt><dt class="spec value" id="val-interval_num_start"><a href="#val-interval_num_start" class="anchor"></a><code><span class="keyword">val </span>interval_num_start : <span class="type-var">_</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="Interval_num/index.html#type-t">Interval_num.t</a> <span>&#45;&gt;</span> <a href="Time/index.html#type-t">Time.t</a></code></dt><dd><p><code>interval_num_start t n</code> is the start of the <code>n</code>'th interval in <code>t</code>, i.e. <code>n * alarm_precision t</code> after the epoch.</p><p><code>interval_start t time</code> is the start of the half-open interval containing <code>time</code>, i.e.:</p><pre><code class="ml">interval_num_start t (interval_num t time)</code></pre><p><code>interval_start</code> raises in the same cases that <code>interval_num</code> does.</p></dd></dl><dl><dt class="spec value" id="val-interval_start"><a href="#val-interval_start" class="anchor"></a><code><span class="keyword">val </span>interval_start : <span class="type-var">_</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="Time/index.html#type-t">Time.t</a> <span>&#45;&gt;</span> <a href="Time/index.html#type-t">Time.t</a></code></dt><dt class="spec value" id="val-advance_clock"><a href="#val-advance_clock" class="anchor"></a><code><span class="keyword">val </span>advance_clock : <span class="type-var">'a</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> to_:<a href="Time/index.html#type-t">Time.t</a> <span>&#45;&gt;</span> handle_fired:(<span class="type-var">'a</span> <a href="Alarm/index.html#type-t">Alarm.t</a> <span>&#45;&gt;</span> Core_kernel__.Import.unit) <span>&#45;&gt;</span> Core_kernel__.Import.unit</code></dt><dd><p><code>advance_clock t ~to_ ~handle_fired</code> advances <code>t</code>'s clock to <code>to_</code>. It fires and removes all alarms <code>a</code> in <code>t</code> with <code>Time.(&lt;) (Alarm.at t a) (interval_start t to_)</code>, applying <code>handle_fired</code> to each such <code>a</code>.</p><p>If <code>to_ &lt;= now t</code>, then <code>advance_clock</code> does nothing.</p><p><code>advance_clock</code> fails if <code>to_</code> is too far in the future to represent.</p><p>Behavior is unspecified if <code>handle_fired</code> accesses <code>t</code> in any way other than <code>Alarm</code> functions.</p></dd></dl><dl><dt class="spec value" id="val-fire_past_alarms"><a href="#val-fire_past_alarms" class="anchor"></a><code><span class="keyword">val </span>fire_past_alarms : <span class="type-var">'a</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> handle_fired:(<span class="type-var">'a</span> <a href="Alarm/index.html#type-t">Alarm.t</a> <span>&#45;&gt;</span> Core_kernel__.Import.unit) <span>&#45;&gt;</span> Core_kernel__.Import.unit</code></dt><dd><p><code>fire_past_alarms t ~handle_fired</code> fires and removes all alarms <code>a</code> in <code>t</code> with <code>Time.( &lt;= ) (Alarm.at t a) (now t)</code>, applying <code>handle_fired</code> to each such <code>a</code>.</p><p><code>fire_past_alarms</code> visits all alarms in interval <code>now_interval_num</code>, to check their <code>Alarm.at</code>.</p><p>Behavior is unspecified if <code>handle_fired</code> accesses <code>t</code> in any way other than <code>Alarm</code> functions.</p></dd></dl><dl><dt class="spec value" id="val-alarm_upper_bound"><a href="#val-alarm_upper_bound" class="anchor"></a><code><span class="keyword">val </span>alarm_upper_bound : <span class="type-var">_</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="Time/index.html#type-t">Time.t</a></code></dt><dd><p><code>alarm_upper_bound t</code> returns the upper bound on an <code>at</code> that can be supplied to <code>add</code>. <code>alarm_upper_bound t</code> is not constant; its value increases as <code>now t</code> increases.</p></dd></dl><dl><dt class="spec value" id="val-add"><a href="#val-add" class="anchor"></a><code><span class="keyword">val </span>add : <span class="type-var">'a</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> at:<a href="Time/index.html#type-t">Time.t</a> <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> <span class="type-var">'a</span> <a href="Alarm/index.html#type-t">Alarm.t</a></code></dt><dd><p><code>add t ~at a</code> adds a new value <code>a</code> to <code>t</code> and returns an alarm that can later be supplied to <code>remove</code> the alarm from <code>t</code>. <code>add</code> raises if <code>interval_num t at &lt;
      now_interval_num t || at &gt;= alarm_upper_bound t</code>.</p><p><code>add_at_interval_num t ~at a</code> is equivalent to <code>add t ~at:(interval_num_start t at)
      a</code>.</p></dd></dl><dl><dt class="spec value" id="val-add_at_interval_num"><a href="#val-add_at_interval_num" class="anchor"></a><code><span class="keyword">val </span>add_at_interval_num : <span class="type-var">'a</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> at:<a href="Interval_num/index.html#type-t">Interval_num.t</a> <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> <span class="type-var">'a</span> <a href="Alarm/index.html#type-t">Alarm.t</a></code></dt><dt class="spec value" id="val-mem"><a href="#val-mem" class="anchor"></a><code><span class="keyword">val </span>mem : <span class="type-var">'a</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span class="type-var">'a</span> <a href="Alarm/index.html#type-t">Alarm.t</a> <span>&#45;&gt;</span> Core_kernel__.Import.bool</code></dt><dt class="spec value" id="val-remove"><a href="#val-remove" class="anchor"></a><code><span class="keyword">val </span>remove : <span class="type-var">'a</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span class="type-var">'a</span> <a href="Alarm/index.html#type-t">Alarm.t</a> <span>&#45;&gt;</span> Core_kernel__.Import.unit</code></dt><dd><p><code>remove t alarm</code> removes <code>alarm</code> from <code>t</code>. <code>remove</code> raises if <code>not (mem t
      alarm)</code>.</p></dd></dl><dl><dt class="spec value" id="val-reschedule"><a href="#val-reschedule" class="anchor"></a><code><span class="keyword">val </span>reschedule : <span class="type-var">'a</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span class="type-var">'a</span> <a href="Alarm/index.html#type-t">Alarm.t</a> <span>&#45;&gt;</span> at:<a href="Time/index.html#type-t">Time.t</a> <span>&#45;&gt;</span> Core_kernel__.Import.unit</code></dt><dd><p><code>reschedule t alarm ~at</code> mutates <code>alarm</code> so that it will fire at <code>at</code>, i.e. so that <code>Alarm.at t alarm = at</code>. <code>reschedule</code> raises if <code>not (mem t alarm)</code> or if <code>at</code> is an invalid time for <code>t</code>, in the same situations that <code>add</code> raises.</p><p><code>reschedule_at_interval_num t alarm ~at</code> is equivalent to:</p><pre><code class="ml">reschedule t alarm ~at:(interval_num_start t at)</code></pre></dd></dl><dl><dt class="spec value" id="val-reschedule_at_interval_num"><a href="#val-reschedule_at_interval_num" class="anchor"></a><code><span class="keyword">val </span>reschedule_at_interval_num : <span class="type-var">'a</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span class="type-var">'a</span> <a href="Alarm/index.html#type-t">Alarm.t</a> <span>&#45;&gt;</span> at:<a href="Interval_num/index.html#type-t">Interval_num.t</a> <span>&#45;&gt;</span> Core_kernel__.Import.unit</code></dt><dt class="spec value" id="val-clear"><a href="#val-clear" class="anchor"></a><code><span class="keyword">val </span>clear : <span class="type-var">_</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> Core_kernel__.Import.unit</code></dt><dd><p><code>clear t</code> removes all alarms from <code>t</code>.</p></dd></dl><dl><dt class="spec value" id="val-min_alarm_interval_num"><a href="#val-min_alarm_interval_num" class="anchor"></a><code><span class="keyword">val </span>min_alarm_interval_num : <span class="type-var">_</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="Interval_num/index.html#type-t">Interval_num.t</a> Core_kernel__.Import.option</code></dt><dd><p><code>min_alarm_interval_num t</code> is the minimum <code>Alarm.interval_num</code> of all alarms in <code>t</code>. <code>min_alarm_interval_num_exn t</code> is the same, except it raises if <code>is_empty
      t</code>.</p></dd></dl><dl><dt class="spec value" id="val-min_alarm_interval_num_exn"><a href="#val-min_alarm_interval_num_exn" class="anchor"></a><code><span class="keyword">val </span>min_alarm_interval_num_exn : <span class="type-var">_</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="Interval_num/index.html#type-t">Interval_num.t</a></code></dt><dt class="spec value" id="val-max_alarm_time_in_min_interval"><a href="#val-max_alarm_time_in_min_interval" class="anchor"></a><code><span class="keyword">val </span>max_alarm_time_in_min_interval : <span class="type-var">'a</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="Time/index.html#type-t">Time.t</a> Core_kernel__.Import.option</code></dt><dd><p><code>max_alarm_time_in_min_interval t</code> returns the maximum <code>Alarm.at</code> over all alarms in <code>t</code> whose <code>Alarm.interval_num</code> is <code>min_alarm_interval_num t</code>.</p><p><code>max_alarm_time_in_min_interval_exn t</code> is the same as <code>max_alarm_time_in_min_interval</code>, except that it raises if <code>is_empty t</code>.</p><p>This function is useful for advancing to the <code>min_alarm_interval_num</code> of a timing wheel and then calling <code>fire_past_alarms</code> to fire the alarms in that interval. That is useful when simulating time, to ensure that alarms are processed in order.</p></dd></dl><dl><dt class="spec value" id="val-max_alarm_time_in_min_interval_exn"><a href="#val-max_alarm_time_in_min_interval_exn" class="anchor"></a><code><span class="keyword">val </span>max_alarm_time_in_min_interval_exn : <span class="type-var">'a</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="Time/index.html#type-t">Time.t</a></code></dt><dt class="spec value" id="val-next_alarm_fires_at"><a href="#val-next_alarm_fires_at" class="anchor"></a><code><span class="keyword">val </span>next_alarm_fires_at : <span class="type-var">_</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="Time/index.html#type-t">Time.t</a> Core_kernel__.Import.option</code></dt><dd><p><code>next_alarm_fires_at t</code> returns the minimum time to which the clock can be advanced such that an alarm will fire, or <code>None</code> if <code>t</code> has no alarms. If <code>next_alarm_fires_at t = Some next</code>, then for the minimum alarm time <code>min</code> that occurs in <code>t</code>, it is guaranteed that: <code>next - alarm_precision t &lt;= min &lt; next</code>.</p><p><code>next_alarm_fires_at_exn</code> is the same as <code>next_alarm_fires_at</code>, except that it raises if <code>is_empty t</code>.</p></dd></dl><dl><dt class="spec value" id="val-next_alarm_fires_at_exn"><a href="#val-next_alarm_fires_at_exn" class="anchor"></a><code><span class="keyword">val </span>next_alarm_fires_at_exn : <span class="type-var">_</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="Time/index.html#type-t">Time.t</a></code></dt></dl><section><header><h6 id="implementation-details"><a href="#implementation-details" class="anchor"></a>Implementation details</h6><p>The rest of this interface is not intended to be used with Timing_wheel, but is a separate data structure used to implement Timing_wheel, and may find use elsewhere.</p></header><dl><dt class="spec module" id="module-Priority_queue"><a href="#module-Priority_queue" class="anchor"></a><code><span class="keyword">module </span><a href="Priority_queue/index.html">Priority_queue</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>Timing wheel is implemented as a priority queue in which the keys are non-negative integers corresponding to the intervals of time. The priority queue is unlike a typical priority queue in that rather than having a &quot;delete min&quot; operation, it has a nondecreasing minimum allowed key, which corresponds to the current time, and an <code>increase_min_allowed_key</code> operation, which implements <code>advance_clock</code>. <code>increase_min_allowed_key</code> as a side effect removes all elements from the timing wheel whose key is smaller than the new minimum, which implements firing the alarms whose time has expired.</p></dd></dl></section></div></body></html>