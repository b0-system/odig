<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Conf (topkg.Topkg.Conf)</title><link rel="stylesheet" href="../../../_odoc-theme/odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../../index.html">topkg</a> &#x00BB; <a href="../index.html">Topkg</a> &#x00BB; Conf</nav><h1>Module <code>Topkg.Conf</code></h1><p>Build configuration.</p><nav class="toc"><ul><li><a href="#kconv">Key value converters</a></li><li><a href="#key">Keys</a></li><li><a href="#conf">Configurations</a></li><li><a href="#tool">Tool lookup</a></li><li><a href="#ocaml">OCaml configuration</a></li></ul></nav></header><section><header><h2 id="kconv"><a href="#kconv" class="anchor"></a>Key value converters</h2></header><dl><dt class="spec type" id="type-conv"><a href="#type-conv" class="anchor"></a><code><span class="keyword">type</span> 'a conv</code></dt><dd><p>The type for key value converters.</p></dd></dl><dl><dt class="spec value" id="val-conv"><a href="#val-conv" class="anchor"></a><code><span class="keyword">val</span> conv : ?&#8288;docv:string <span>&#45;&gt;</span> (string <span>&#45;&gt;</span> <span class="type-var">'a</span> <a href="../index.html#type-result">result</a>) <span>&#45;&gt;</span> (<a href="../../../ocaml/Stdlib/Format/index.html#type-formatter">Stdlib.Format.formatter</a> <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> unit) <span>&#45;&gt;</span> <span class="type-var">'a</span> <a href="index.html#type-conv">conv</a></code></dt><dd><p><code>conv ~docv parse print</code> is a configuration value converter parsing values with <code>parse</code> and printing them with <code>print</code>. <code>docv</code> is a documentation meta-variable used in the documentation to stand for the configuration value, defaults to <code>&quot;VALUE&quot;</code>.</p></dd></dl><dl><dt class="spec value" id="val-bool"><a href="#val-bool" class="anchor"></a><code><span class="keyword">val</span> bool : bool <a href="index.html#type-conv">conv</a></code></dt><dd><p><code>bool</code> is a converter for booleans.</p></dd></dl><dl><dt class="spec value" id="val-int"><a href="#val-int" class="anchor"></a><code><span class="keyword">val</span> int : int <a href="index.html#type-conv">conv</a></code></dt><dd><p><code>int</code> is a converter for integers.</p></dd></dl><dl><dt class="spec value" id="val-string"><a href="#val-string" class="anchor"></a><code><span class="keyword">val</span> string : string <a href="index.html#type-conv">conv</a></code></dt><dd><p><code>string</code> is a converter for strings.</p></dd></dl><dl><dt class="spec value" id="val-fpath"><a href="#val-fpath" class="anchor"></a><code><span class="keyword">val</span> fpath : <a href="../index.html#type-fpath">fpath</a> <a href="index.html#type-conv">conv</a></code></dt><dd><p><code>fpath</code> is a converter for file paths.</p></dd></dl><dl><dt class="spec value" id="val-some"><a href="#val-some" class="anchor"></a><code><span class="keyword">val</span> some : ?&#8288;none:string <span>&#45;&gt;</span> <span class="type-var">'a</span> <a href="index.html#type-conv">conv</a> <span>&#45;&gt;</span> <span class="type-var">'a</span> option <a href="index.html#type-conv">conv</a></code></dt><dd><p><code>some conv</code> is like <code>conv</code> but wraps the parsed value in <code>Some</code>. <code>none</code> is the string printed for <code>None</code> by the converter printer, defaults to <code>&quot;&quot;</code>.</p></dd></dl></section><section><header><h2 id="key"><a href="#key" class="anchor"></a>Keys</h2><p><b>Warning.</b> Configuration keys must be created before the call to <a href="../Pkg/index.html#val-describe"><code>Pkg.describe</code></a>. Yes you are right, that's a little bit dirty.</p></header><dl><dt class="spec type" id="type-key"><a href="#type-key" class="anchor"></a><code><span class="keyword">type</span> 'a key</code></dt><dd><p>The type for configuration keys whose lookup value is of type <code>'a</code>.</p><p>A configuration key has a name and represents a value of type <code>'a</code> in a build configuration. If <code>&quot;name&quot;</code> is the name of the key then its value can be specified on the command line using <code>--name v</code> where <code>v</code> is the value of the key and is parsed according to the key's <a href="index.html#type-conv"><span>value converter</span></a>.</p><p>There are a few predefined key, see the <a href="index.html#conf"><span>configuration section</span></a>.</p></dd></dl><dl><dt class="spec value" id="val-key"><a href="#val-key" class="anchor"></a><code><span class="keyword">val</span> key : ?&#8288;docv:string <span>&#45;&gt;</span> ?&#8288;doc:string <span>&#45;&gt;</span> ?&#8288;env:string <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <span class="type-var">'a</span> <a href="index.html#type-conv">conv</a> <span>&#45;&gt;</span> absent:<span class="type-var">'a</span> <span>&#45;&gt;</span> <span class="type-var">'a</span> <a href="index.html#type-key">key</a></code></dt><dd><p><code>key name conv ~absent ~env ~doc ~docv</code> is a configuration key with name <code>name</code> parsed from the command line with <code>conv</code>. <code>absent</code> is used if the value is not specified on the command line. If <code>env</code> is specified and exists in the process environment, the value of the variable is parsed with <code>conv</code> and used instead of <code>absent</code> when needed.</p><p><code>doc</code> is a documentation string for the key. <code>docv</code> is a documentation meta-variable to stand for the key value, defaulting to the <code>docv</code> of <code>conv</code>. In <code>doc</code>, occurences of the substring <code>&quot;$(docv)&quot;</code> are replaced by the value of <code>docv</code>.</p></dd></dl><dl><dt class="spec value" id="val-discovered_key"><a href="#val-discovered_key" class="anchor"></a><code><span class="keyword">val</span> discovered_key : ?&#8288;docv:string <span>&#45;&gt;</span> ?&#8288;doc:string <span>&#45;&gt;</span> ?&#8288;env:string <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <span class="type-var">'a</span> <a href="index.html#type-conv">conv</a> <span>&#45;&gt;</span> absent:(unit <span>&#45;&gt;</span> <span class="type-var">'a</span> <a href="../index.html#type-result">result</a>) <span>&#45;&gt;</span> <span class="type-var">'a</span> <a href="index.html#type-key">key</a></code></dt><dd><p><code>discovered_key</code> is like <a href="index.html#key"><span>Keys</span></a> but the absent value is discovered, <em>if needed</em>, with <code>absent</code>.</p></dd></dl><dl><dt class="spec value" id="val-with_pkg"><a href="#val-with_pkg" class="anchor"></a><code><span class="keyword">val</span> with_pkg : ?&#8288;default:bool <span>&#45;&gt;</span> string <span>&#45;&gt;</span> bool <a href="index.html#type-key">key</a></code></dt><dd><p><code>with_pkg ~default pkg</code> is a boolean configuration key named <code>(strf &quot;with-%s&quot; pkg)</code> to assert existence of opam packages. If absent defaults to <code>default</code>.</p><p>Usually specified in opam build instructions with:</p><pre><code class="ml">&quot;--with-thatpkg&quot; thatpkg:installed</code></pre><p>along with an entry in the depopt field of the opam file.</p><p><b>Warning.</b> Only use this combinator for denoting opam package existence, the resulting key may switch to a discovery process in the future.</p></dd></dl></section><section><header><h2 id="conf"><a href="#conf" class="anchor"></a>Configurations</h2></header><dl><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> t</code></dt><dd><p>The type for configurations.</p></dd></dl><dl><dt class="spec value" id="val-value"><a href="#val-value" class="anchor"></a><code><span class="keyword">val</span> value : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span class="type-var">'a</span> <a href="index.html#type-key">key</a> <span>&#45;&gt;</span> <span class="type-var">'a</span></code></dt><dd><p><code>value c k</code> is the value of configuration key <code>k</code> in <code>c</code>.</p><dl><dt>raises Invalid_argument</dt><dd><p>If <code>k</code> was (illegaly) created after the call to <a href="../Pkg/index.html#val-describe"><code>Pkg.describe</code></a> or if dirty tricks are being played.</p></dd></dl></dd></dl><dl><dt class="spec value" id="val-pkg_name"><a href="#val-pkg_name" class="anchor"></a><code><span class="keyword">val</span> pkg_name : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> string</code></dt><dd><p><code>pkg_name c</code> is either the value of the package name as given to <a href="../Pkg/index.html#val-describe"><code>Pkg.describe</code></a> or the value of a predefined key <code>--pkg-name</code> which overrides the package name. This defines the name of the generated opam install file. Used to handle <a href="../index.html#multiopam"><span>multiple opam packages</span></a>.</p></dd></dl><dl><dt class="spec value" id="val-build_dir"><a href="#val-build_dir" class="anchor"></a><code><span class="keyword">val</span> build_dir : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../index.html#type-fpath">fpath</a></code></dt><dd><p><code>build_dir c</code> is either the value of build directory as given to <a href="../Pkg/index.html#val-describe"><code>Pkg.describe</code></a> via <a href="../Pkg/index.html#build"><span>Build description</span></a> or the value of a predefined key <code>--build-dir</code> which overrides the package definition.</p></dd></dl><dl><dt class="spec value" id="val-vcs"><a href="#val-vcs" class="anchor"></a><code><span class="keyword">val</span> vcs : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> bool</code></dt><dd><p><code>vcs c</code> is the value of a predefined key <code>--vcs</code>. It is <code>true</code> if the package directory is VCS managed. Usually should not be specified manually: if absent it is determined automatically by using <a href="../Vcs/index.html#val-find"><code>Topkg.Vcs.find</code></a> and used to determine the <a href="index.html#type-build_context"><code>build_context</code></a>.</p></dd></dl><dl><dt class="spec value" id="val-dev_pkg"><a href="#val-dev_pkg" class="anchor"></a><code><span class="keyword">val</span> dev_pkg : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> bool</code></dt><dd><p><code>dev_pkg c</code> is the value of a predefined key <code>--dev-pkg</code>. It is <code>true</code> if the build is initiated by an installer like opam and the package sources are a checkout from a VCS rather than a distribution archive. Usually specified in opam build instruction with either:</p><pre><code class="ml">&quot;--dev-pkg&quot; &quot;%{dev}%&quot;    # for opam &gt;= 2.0
&quot;--dev-pkg&quot; &quot;%{pinned}%&quot; #           &lt; 2.0</code></pre></dd></dl><dl><dt class="spec value" id="val-pinned"><a href="#val-pinned" class="anchor"></a><code><span class="keyword">val</span> pinned : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> bool</code></dt><dd><dl><dt>deprecated</dt><dd><p>use <a href="index.html#val-dev_pkg"><code>dev_pkg</code></a></p><p><code>pinned c</code> is the value of a predefined key <code>--pinned</code>. It has exactly the same semantics as <a href="index.html#val-dev_pkg"><code>dev_pkg</code></a> but is misnamed.</p></dd></dl></dd></dl><dl><dt class="spec value" id="val-jobs"><a href="#val-jobs" class="anchor"></a><code><span class="keyword">val</span> jobs : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> int</code></dt><dd><p><code>jobs c</code> is the value of a predefined key <code>--jobs</code>. If absent it is determined from the build context as follows.</p><ul><li><code>`Dev</code> builds default to number of CPU cores, or 4 if it cannot be determined.</li><li>all other contexts default to 4</li></ul></dd></dl><dl><dt class="spec type" id="type-build_context"><a href="#type-build_context" class="anchor"></a><code><span class="keyword">type</span> build_context</code> = <code>[ </code><table class="variant"><tr id="type-build_context.Dev" class="anchored"><td class="def constructor"><a href="#type-build_context.Dev" class="anchor"></a><code>| </code><code>`Dev</code></td></tr><tr id="type-build_context.Distrib" class="anchored"><td class="def constructor"><a href="#type-build_context.Distrib" class="anchor"></a><code>| </code><code>`Distrib</code></td></tr><tr id="type-build_context.Pin" class="anchored"><td class="def constructor"><a href="#type-build_context.Pin" class="anchor"></a><code>| </code><code>`Pin</code></td></tr></table><code> ]</code></dt><dd><p>The type for build contexts. See <a href="index.html#val-build_context"><code>build_context</code></a> for semantics.</p></dd></dl><dl><dt class="spec value" id="val-build_context"><a href="#val-build_context" class="anchor"></a><code><span class="keyword">val</span> build_context : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> [ `Dev | `Distrib | `Pin ]</code></dt><dd><p><code>build_context c</code> is the build context of <code>c</code>. This is derived from <a href="index.html#val-vcs"><code>vcs</code></a> and <a href="index.html#val-dev_pkg"><code>dev_pkg</code></a> (or the deprecated <a href="index.html#val-pinned"><code>pinned</code></a>) as follows.</p><ul><li><code>`Distrib</code> iff <code>not (vcs c)</code>. No VCS is present, this is a build from a distribution. If there are configuration bits they should be setup according to the build configuration.</li><li><code>`Dev</code> iff <code>vcs c &amp;&amp; not (dev_pkg c || pinned c)</code>. This is a development build invoked manually in a source repository. The repository checkout should likely not be touched and configuration bits not be setup. This is happening for example if the developer is testing the package description in her working source repository by invoking <code>pkg/pkg.ml</code> or <code>topkg build</code>.</li><li><code>`Pin</code> iff <code>vcs c &amp;&amp; (dev_pkg c || pinned c)</code>. This is a package manager development build. In this case the repository checkout may need to be massaged into a pseudo-distribution for the package to be installed. This means that distribution watermarking and massaging should be performed, see <a href="../Pkg/index.html#distrib"><span>Distribution description</span></a> and the <code>prepare_on_pin</code> argument of <a href="../Pkg/index.html#build"><span>Build description</span></a>. Besides exisiting configuration bits should be setup according to the build environment. <b>Note.</b> This is called <code>`Pin</code> due to a blind spot, a more approriate name would be something like <code>`Dev_pkg</code> build.</li></ul></dd></dl><dl><dt class="spec value" id="val-build_tests"><a href="#val-build_tests" class="anchor"></a><code><span class="keyword">val</span> build_tests : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> bool</code></dt><dd><p><code>build_tests c</code> is the value of a predefined key <code>--tests</code> that indicates if the tests should be built. If absent the value depends on the <a href="index.html#type-build_context"><code>build_context</code></a>, it is <code>true</code> in the <code>`Dev</code> context and <code>false</code> in the other contexts.</p></dd></dl><dl><dt class="spec value" id="val-debug"><a href="#val-debug" class="anchor"></a><code><span class="keyword">val</span> debug : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> bool</code></dt><dd><p><code>debug c</code> is the value of a predefined key <code>--debug</code> that indicates if the build should include debugging information in the build artefacts. If absent the value is <code>true</code> or the value of the environment variable TOPKG_CONF_DEBUG if specified.</p></dd></dl><dl><dt class="spec value" id="val-debugger_support"><a href="#val-debugger_support" class="anchor"></a><code><span class="keyword">val</span> debugger_support : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> bool</code></dt><dd><p><code>debugger_support c</code> is the value of a predefined key <code>--debugger-support</code> that indicates if build artefacts needed for source level debuggers should be built and installed. If absent the value is <code>false</code> or the value of the environment variable TOPKG_CONF_DEBUGGER_SUPPORT if specified.</p></dd></dl><dl><dt class="spec value" id="val-profile"><a href="#val-profile" class="anchor"></a><code><span class="keyword">val</span> profile : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> bool</code></dt><dd><p><code>profile c</code> is the value of a predefined key <code>--profile</code> that indicates if the build artefacts include run-time profiling support. If absent the value is <code>false</code> or the value of the environment variable TOPKG_CONF_PROFILE if specified.</p></dd></dl><dl><dt class="spec value" id="val-toolchain"><a href="#val-toolchain" class="anchor"></a><code><span class="keyword">val</span> toolchain : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> string option</code></dt><dd><p><code>toolchain c</code> is the value of a predefined key <code>--toolchain</code> that specifies the ocamlbuild toolchain. If absent the value is <code>None</code> or the value of the environment variable TOPKG_CONF_TOOLCHAIN if specified.</p></dd></dl><dl><dt class="spec value" id="val-dump"><a href="#val-dump" class="anchor"></a><code><span class="keyword">val</span> dump : <a href="../../../ocaml/Stdlib/Format/index.html#type-formatter">Stdlib.Format.formatter</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> unit</code></dt><dd><p><code>dump ppf c</code> formats an unspecified representation of <code>c</code> on <code>ppf</code>.</p></dd></dl></section><section><header><h2 id="tool"><a href="#tool" class="anchor"></a>Tool lookup</h2><p>If your package description needs to run tools (e.g. in the pre and post build hooks, see <a href="../Pkg/index.html#build"><span>Build description</span></a>) it should get the tool to invoke with the following function. This allows to control the executable being run which is useful for cross-compilation scenarios.</p></header><dl><dt class="spec type" id="type-os"><a href="#type-os" class="anchor"></a><code><span class="keyword">type</span> os</code> = <code>[ </code><table class="variant"><tr id="type-os.Build_os" class="anchored"><td class="def constructor"><a href="#type-os.Build_os" class="anchor"></a><code>| </code><code>`Build_os</code></td></tr><tr id="type-os.Host_os" class="anchored"><td class="def constructor"><a href="#type-os.Host_os" class="anchor"></a><code>| </code><code>`Host_os</code></td></tr></table><code> ]</code></dt><dd><p>The type for operating systems.</p><ul><li><code>`Build_os</code> is the build OS, the OS on which the package is built.</li><li><code>`Host_os</code> is the host OS, the OS on which the package is hosted and runs.</li></ul></dd></dl><dl><dt class="spec value" id="val-tool"><a href="#val-tool" class="anchor"></a><code><span class="keyword">val</span> tool : ?&#8288;conf:<a href="index.html#type-t">t</a> <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <a href="index.html#type-os">os</a> <span>&#45;&gt;</span> <a href="../Cmd/index.html#type-t">Cmd.t</a></code></dt><dd><p><code>tool ~conf cmd os</code> is a command <code>cmd</code> which can be run on the build OS which produces output suitable for the OS <code>os</code>, taking into account configuration <code>conf</code>.</p><p>The actual command returned depends on the following lookup procedure, here exemplified on the invocation <code>tool &quot;mytool&quot; `Host_os</code> (resp. <code>`Build_os</code>).</p><ol><li><code>Cmd.v &quot;cmd&quot;</code>, if the environment variable HOST_OS_MYTOOL (resp. BUILD_OS_MYTOOL) is set to <code>&quot;cmd&quot;</code></li><li><code>Cmd.v (Fpath.append path &quot;mytool&quot;)</code>, if the environment variable HOST_OS_XBIN (resp. BUILD_OS_BIN) is set to <code>path</code>.</li><li><code>Cmd.v (&quot;mytool&quot; ^ &quot;suff&quot;)</code>, if the environment variable HOST_OS_SUFF (resp. BUILD_OS_SUFF).</li><li><code>Cmd.(v &quot;ocamlfind&quot; % &quot;-toolchain&quot; % &quot;toolchain&quot; % &quot;mytool&quot;)</code> if <code>&quot;mytool&quot;</code> is part of the OCaml tools that can be invoked through ocamlfind, <code>toolchain conf</code> is not <code>None</code>, and <code>os</code> is <code>`Host_os</code>.</li><li><code>Cmd.(v &quot;ocamlfind&quot; % &quot;mytool&quot;)</code> if <code>&quot;mytool&quot;</code> is part of the OCaml tools that can be invoked through ocamlfind.</li><li><code>Cmd.v &quot;mytool&quot;</code> otherwise.</li></ol></dd></dl></section><section><header><h2 id="ocaml"><a href="#ocaml" class="anchor"></a>OCaml configuration</h2></header><dl><dt class="spec module" id="module-OCaml"><a href="#module-OCaml" class="anchor"></a><code><span class="keyword">module</span> <a href="OCaml/index.html">OCaml</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>OCaml configuration.</p></dd></dl></section></div></body></html>