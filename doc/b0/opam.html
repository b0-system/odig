<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>opam (b0.opam)</title><link rel="stylesheet" href="../_odoc-theme/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.0.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="index.html">Up</a> – <a href="index.html">b0</a> &#x00BB; opam</nav><header class="odoc-preamble"><h1 id="opam-support-manual"><a href="#opam-support-manual" class="anchor"></a><code>opam</code> support manual</h1><p><a href="B0_opam/index.html"><code>B0_opam</code></a> has support for <a href="http://opam.ocaml.org/"><code>opam</code></a>, the OCaml package manager. It provides a convention to represent <code>opam</code> packages in <code>B0</code> and cmdlets for <code>opam</code> package file generation and automated package publication on the OCaml <code>opam</code> repository.</p></header><nav class="odoc-toc"><ul><li><a href="#representation">Package representation</a></li><li><a href="#file_generation">Package file generation</a></li><li><a href="#publish">Package publication</a><ul><li><a href="#github">GitHub setup</a></li><li><a href="#basic">Basics</a></li><li><a href="#det_version">Version determination</a></li><li><a href="#det_archive_url">Release archive URL determination</a></li><li><a href="#det_release_notes">Release notes determination</a></li><li><a href="#incompatibilities">Stating incompatibilities</a></li><li><a href="#problems">Dealing with pull request issues</a></li></ul></li><li><a href="#cookbook">Cookbook</a><ul><li><a href="#multiple_packages">Multiple packages from the same source archive</a></li></ul></li></ul></nav><div class="odoc-content"><h2 id="representation"><a href="#representation" class="anchor"></a>Package representation</h2><p><code>opam</code> packages are represented in <code>B0</code> by <a href="manual.html#packs">build packs</a> tagged with the <a href="B0_opam/index.html#val-tag"><code>B0_opam.tag</code></a>. The name of the defined <code>opam</code> package is the basename of the pack or the value of the <a href="B0_opam/Meta/index.html#val-name"><code>B0_opam.Meta.name</code></a> metadata key; see <a href="B0_opam/index.html#val-pkg_name_of_pack"><code>B0_opam.pkg_name_of_pack</code></a> for the full details.</p><p>The metadata of the <code>opam</code> package is defined by the pack's <a href="B0_meta/index.html#std">standard</a> and <a href="B0_opam/Meta/index.html"><code>opam</code> specific</a> metadata key values. The map between metadata key and opam fields is described in <a href="B0_opam/File/index.html#val-pkg_of_meta"><code>B0_opam.File.pkg_of_meta</code></a>. Some keys are derived by <a href="B0_opam/Meta/index.html#val-pkg_of_pack"><code>B0_opam.Meta.pkg_of_pack</code></a> if unspecified.</p><p>The pack <em>should</em> contain exactly the build units that must be built by the <code>opam</code> package, this allows <a href="B0_opam/Meta/index.html#val-pkg_of_pack"><code>B0_opam.Meta.pkg_of_pack</code></a> to automatically infer some of the fields (e.g. <code>build:</code> or <code>depends:</code>).</p><p>Here's an example:</p><pre><code>let mypkg =
  let meta =
    let open B0_meta in
    empty
    |&gt; tag B0_opam.tag
    |&gt; add authors [&quot;The mylib programmers&quot;]
    |&gt; add maintainers [&quot;mylib@example.org&quot;]
    |&gt; add homepage &quot;https://example.org/software/mylib&quot;
    |&gt; add online_doc &quot;https://example.org/software/mylib/doc&quot;
    |&gt; add license [&quot;MIT&quot;]
    |&gt; add repo &quot;git+https://example.org/repos/mylib.git&quot;
    |&gt; add issues &quot;https://github.com/mylib/mylib/issues&quot;
    |&gt; add B0_opam.Meta.depends [
       &quot;ocaml&quot;, {|&gt;= &quot;4.10.0&quot; |} ]
  in
  B0_pack.v &quot;mypkg&quot; ~doc:&quot;opam package mypkg&quot; ~meta ~locked:true @@
  B0_unit.list () (* You likely want to be more refined than that *)</code></pre><p>The <code>opam</code> packages defined in a B0 root along with the pack in which they are defined can be listed with the <code>.opam.list</code> cmdlet.</p><pre>b0 cmd -- .opam.list           # List opam packages in the B0 root
b0 cmd -- .opam.list --help    # See more options</pre><h2 id="file_generation"><a href="#file_generation" class="anchor"></a>Package file generation</h2><p>The <code>opam</code> file for a package is generated from its pack metadata via <a href="B0_opam/Meta/index.html#val-pkg_of_pack"><code>B0_opam.Meta.pkg_of_pack</code></a> and <a href="B0_opam/File/index.html#val-pkg_of_meta"><code>B0_opam.File.pkg_of_meta</code></a>.</p><p>The <code>.opam.file</code> cmdlet outputs the generated files in various ways.</p><pre>b0 cmd -- .opam.file mypkg             # opam file for mypkg on stdout
b0 cmd -- .opam.file                   # All packages, on stdout
b0 cmd -- .opam.file -d /tmp/opam/     # Write them to /tmp/opam
b0 cmd -- .opam.file --in-scope-dir    # Write them in their scopes
b0 cmd -- .opam.file --help            # See more options</pre><p>Note that the generation differs slightly when <code>opam</code> files are written to stdout, the <code>name:</code> field is added; use option <code>--no-name</code> to prevent that.</p><h2 id="publish"><a href="#publish" class="anchor"></a>Package publication</h2><p>The <code>.opam.publish</code> cmdlet publishes packages on <code>opam</code> by making a pull request on the OCaml <code>opam</code> package repository on GitHub.</p><h3 id="github"><a href="#github" class="anchor"></a>GitHub setup</h3><p>In order to be able to make a pull request on the OCaml <code>opam</code> package repository in the name of your GitHub <code>$USER</code> you need to:</p><ol><li><p>Create a personal access token for <code>$USER</code> with <code>repo</code> permission by following <a href="https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token">these instructions</a>. Paste the token in the file <code>~/.config/b0/github/$USER.token</code> and:</p><pre>    chmod 600 ~/.config/b0/github/$USER.token</pre><p>Alternatively you can specify the user and the token in the <code>B0_GITHUB_{USER,TOKEN}</code> environment variables.</p></li><li>Fork the <a href="https://github.com/ocaml/opam-repository">OCaml opam repository</a> so that it becomes available from <code>https://github.com/$USER/opam-repository</code>.</li></ol><h3 id="basic"><a href="#basic" class="anchor"></a>Basics</h3><p><code>opam</code> package publication happens after the software source archive has been released on the WWW. To get help for releasing your software with B0 see the <a href="release.html">B0 release manual</a>.</p><p>The publication process depends on the current work tree of the VCSes that are in your B0 root as follows:</p><ul><li>The current metadata of the packs defining <code>opam</code> packages is used to generate the <code>opam</code> package files to publish. See <a href="#file_generation">Package file generation</a>.</li><li>The last reachable annotated tags of the VCSes in charge of the packs defining <code>opam</code> packages define the published versions; unless they are explictely specified on the command line. See <a href="#det_version">Version determination</a>.</li><li>The first section of the current changelog files are used to derive release notes added to the pull request. See <a href="#det_release_notes">Release notes determination</a></li></ul><p>Multiple package releases and incompatibilites with existing packages can be stated via a single pull request. For example:</p><pre>b0 cmd -- .opam.publish p1 p2 p3.2.0.1 -i otherpackage</pre><p>publishes the <code>opam</code> packages <code>p1</code> and <code>p2</code> at a version determined by the VCSes in charge of the packs that define them, <code>p3</code> at version <code>2.0.1</code> and states that all versions of <code>otherpackage</code> are incompatible with these new versions – for those that exist in its dependencies.</p><p>Effectively it does the following. For each <code>opam</code> package <code>p</code> given on the command line it:</p><ol><li><a href="#det_version">Determines</a> the package version.</li><li><a href="#det_archive_url">Determines</a> the URL of the package's release archive to download.</li><li>Downloads the archive and checksums it via the <code>shasum</code> tool.</li><li><a href="#file_generation">Generates</a> a versioned opam package file along with a checksumed <code>url:</code> field to the archive.</li><li><a href="#det_release_notes">Determines</a> release notes for the package; for adding information on the pull request.</li></ol><p>If everything worked well it continues with:</p><ol><li>Clones or updates the OCaml <code>opam</code> repository to the shallow and bare repository <code>~/.caches/opam-repository.git</code> (the <a href="B00_std/Os/Dir/index.html#val-cache">XDG spec</a> is honoured).</li><li>Creates a branch for the publication, adds a commit with the generated files and constraints on incompatible packages.</li><li>Pushes the branch on your fork of the OCaml <code>opam</code> repository on GitHub.</li><li>Opens a pull request for the branch on the OCaml <code>opam</code> repository on GitHub.</li></ol><p>Invoking the cmdlet with <code>--check-only</code> outputs on stdout the various bits that are being derived and performs various checks; e.g. it lints <code>opam</code> files and HTTP HEADs archives to checks that they are not 404.</p><h3 id="det_version"><a href="#det_version" class="anchor"></a>Version determination</h3><p>The version number of a package can be specified explicitely on the command line by separating it with a dot from the <code>opam</code> package name. For example <code>mypkg.2.0.1</code> publishes version <code>2.0.1</code> of the package. If no version number is explicitely given it is defined by using <a href="B0_release/index.html#val-version_of_pack"><code>B0_release.version_of_pack</code></a> on its pack.</p><h3 id="det_archive_url"><a href="#det_archive_url" class="anchor"></a>Release archive URL determination</h3><p>The URL to the source archive of the <code>opam</code> package is determined by its pack and <a href="#det_version">version</a> via <a href="B0_release/index.html#val-src_archive_url_of_pack"><code>B0_release.src_archive_url_of_pack</code></a>.</p><p>Note that the archive name defaults to the pack name when unspecified. If you want to define multiple packages for the same source archive you will need to define the <a href="B0_release/Meta/index.html#val-src_archive_name"><code>B0_release.Meta.src_archive_name</code></a> appropriately.</p><p>For example suppose that in addition to <code>mypkg</code> you publish on <code>opam</code> a separate package <code>mypkg-unix</code> which compiles the <code>Unix</code> library support from the same source achive as <code>mypkg</code>. In the metadata of the pack defining the package <code>mypkg-unix</code> you can add:</p><pre><code>let mypkg = ...
let mypkg_unix =
  let meta =
    let open B0_meta in
    empty
    ...
    |&gt; add B0_release.Meta.src_archive_name (B0_pack.basename mypkg)
  in
  B0_pack.v &quot;mypkg-unix&quot; ~meta @@ mypkg_unix_units</code></pre><h3 id="det_release_notes"><a href="#det_release_notes" class="anchor"></a>Release notes determination</h3><p>The release notes of the <code>opam</code> package are determined by looking for a file <code>CHANGES.md</code> in the scope directory of its pack and picking up the first section. See <a href="B0_release/index.html#val-changes_file_of_pack"><code>B0_release.changes_file_of_pack</code></a> and <a href="B0_release/index.html#val-changes_latest_of_file"><code>B0_release.changes_latest_of_file</code></a>.</p><p>Packages sharing the same release notes are aggregated in the pull request.</p><h3 id="incompatibilities"><a href="#incompatibilities" class="anchor"></a>Stating incompatibilities</h3><p><b>FIXME.</b> We need <a href="https://github.com/ocaml/opam/issues/3077">this</a> in <code>opam-admin</code> to make that a reality. For now the best way is to make a separate request manually to state the incompatibilities and have it merged before your pull request and/or manually tweak the automated pull request.</p><p>If you know that some existing <code>opam</code> package <code>PKG</code> of the repository fails because of the new releases. You can state the incompatibility with the repeatable <code>-i PKG[.version]</code> option. This will add an upper bound on <code>PKG</code> as needed.</p><p>For example the following publishes a new <code>mypkg</code> and states that all versions of <code>otherpack</code> and the version 2.1.0 of <code>thispack</code> are incompatible with it – provided <code>mypkg</code> is in their dependencies:</p><pre>b0 cmd -- .opam.publish mypkg -i otherpack -i thispack.2.1.0</pre><p>If you discover the incompatibilites only once the pull request has been made, repeat the same <code>.opam.publish</code> invocation with more <code>-i</code> options, this will update the pull request.</p><h3 id="problems"><a href="#problems" class="anchor"></a>Dealing with pull request issues</h3><p>If there are issues with the pull request you can adjust your metadata and invoke again the same <code>.opam.publish</code> command. As long as the same set of <code>opam</code> packages with the same version end-up being published this updates the existing pull request.</p><p>In particular gradually <a href="#incompatibilities">stating incompatibilites</a> will update the pull request.</p><h2 id="cookbook"><a href="#cookbook" class="anchor"></a>Cookbook</h2><h3 id="multiple_packages"><a href="#multiple_packages" class="anchor"></a>Multiple packages from the same source archive</h3><p>If you want to define multiple packages from a single archive tarball follow the instructions in <a href="#det_archive_url">Release archive URL determination</a>.</p></div></body></html>