<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Memo (b0.B00.Memo)</title><link rel="stylesheet" href="../../../_odoc-theme/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.0.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../../index.html">b0</a> &#x00BB; <a href="../index.html">B00</a> &#x00BB; Memo</nav><header class="odoc-preamble"><h1>Module <code><span>B00.Memo</span></code></h1><p>Build memoizer.</p><p>A memoizer ties together and environment, an operation cache, a guard and an executor.</p></header><nav class="odoc-toc"><ul><li><a href="#lookup">Tool lookup</a></li><li><a href="#memo">Memoizer</a></li><li><a href="#marks">Activity marks</a><ul><li><a href="#proc">Procedures</a></li></ul></li><li><a href="#feedback">Feedback</a></li><li><a href="#files">Files and directories</a></li><li><a href="#spawn">Memoizing tool spawns</a></li></ul></nav><div class="odoc-content"><div class="odoc-spec"><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>The type for memoizers. This ties together an environment, a guard, an operation cache and an executor.</p></div></div><h2 id="lookup"><a href="#lookup" class="anchor"></a>Tool lookup</h2><div class="odoc-spec"><div class="spec type" id="type-tool_lookup" class="anchored"><a href="#type-tool_lookup" class="anchor"></a><code><span><span class="keyword">type</span> tool_lookup</span><span> = <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../B00_std/Cmd/index.html#type-tool">B00_std.Cmd.tool</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a>, string)</span> <a href="../../../ocaml/Stdlib/index.html#type-result">result</a></span> <a href="../../B00_std/Fut/index.html#type-t">B00_std.Fut.t</a></span></span></code></div><div class="spec-doc"><p>The type for tool lookups. Given a command line tool <a href="../../B00_std/Cmd/index.html#type-tool">specification</a> returns a file path to the tool executable or an error message mentioning the tool if it cannot be found.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-tool_lookup_of_os_env" class="anchored"><a href="#val-tool_lookup_of_os_env" class="anchor"></a><code><span><span class="keyword">val</span> tool_lookup_of_os_env : <span>?sep:string <span class="arrow">&#45;&gt;</span></span> <span>?var:string <span class="arrow">&#45;&gt;</span></span> <span><a href="../../B00_std/Os/Env/index.html#type-t">B00_std.Os.Env.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-tool_lookup">tool_lookup</a></span></code></div><div class="spec-doc"><p><code>env_tool_lookup ~sep ~var env</code> is a tool lookup that gets the value of the <code>var</code> variable in <code>env</code> treats it as a <code>sep</code> separated <a href="../../B00_std/Fpath/index.html#val-list_of_search_path">search path</a> and uses the result to lookup with <a href="../../B00_std/Os/Cmd/index.html#val-get"><code>B00_std.Os.Cmd.get</code></a> with the memo's <a href="#val-win_exe"><code>win_exe</code></a>. <code>var</code> defaults to <code>PATH</code> and <code>sep</code> to <a href="../../B00_std/Fpath/index.html#val-search_path_sep"><code>B00_std.Fpath.search_path_sep</code></a>.</p></div></div><h2 id="memo"><a href="#memo" class="anchor"></a>Memoizer</h2><div class="odoc-spec"><div class="spec type" id="type-feedback" class="anchored"><a href="#type-feedback" class="anchor"></a><code><span><span class="keyword">type</span> feedback</span><span> = </span><span>[ </span></code><table><tr id="type-feedback.Miss_tool" class="anchored"><td class="def constructor"><a href="#type-feedback.Miss_tool" class="anchor"></a><code><span>| </span></code><code><span>`Miss_tool <span class="keyword">of</span> <a href="../Tool/index.html#type-t">Tool.t</a> * string</span></code></td></tr><tr id="type-feedback.Op_complete" class="anchored"><td class="def constructor"><a href="#type-feedback.Op_complete" class="anchor"></a><code><span>| </span></code><code><span>`Op_complete <span class="keyword">of</span> <a href="../../B000/Op/index.html#type-t">B000.Op.t</a></span></code></td></tr></table><code><span> ]</span></code></div><div class="spec-doc"><p>The type for memoizer feedback. FIXME remove `Miss_tool now that we have notify operations.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-create" class="anchored"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : <span>?clock:<a href="../../B00_std/Time/index.html#type-counter">B00_std.Time.counter</a> <span class="arrow">&#45;&gt;</span></span> <span>?cpu_clock:<a href="../../B00_std/Time/index.html#type-cpu_counter">B00_std.Time.cpu_counter</a> <span class="arrow">&#45;&gt;</span></span> <span>feedback:<span>(<span><a href="#type-feedback">feedback</a> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span> <span>cwd:<a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> <span class="arrow">&#45;&gt;</span></span> <span>?win_exe:bool <span class="arrow">&#45;&gt;</span></span>
<span>?tool_lookup:<a href="#type-tool_lookup">tool_lookup</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Env/index.html#type-t">Env.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../B000/Guard/index.html#type-t">B000.Guard.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../B000/Reviver/index.html#type-t">B000.Reviver.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../B000/Exec/index.html#type-t">B000.Exec.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-memo" class="anchored"><a href="#val-memo" class="anchor"></a><code><span><span class="keyword">val</span> memo : <span>?hash_fun:<span>(<span class="keyword">module</span> <a href="../../B00_std/Hash/module-type-T/index.html">B00_std.Hash.T</a>)</span> <span class="arrow">&#45;&gt;</span></span> <span>?win_exe:bool <span class="arrow">&#45;&gt;</span></span> <span>?tool_lookup:<a href="#type-tool_lookup">tool_lookup</a> <span class="arrow">&#45;&gt;</span></span> <span>?env:<a href="../../B00_std/Os/Env/index.html#type-t">B00_std.Os.Env.t</a> <span class="arrow">&#45;&gt;</span></span> <span>?cwd:<a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> <span class="arrow">&#45;&gt;</span></span>
<span>?cache_dir:<a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> <span class="arrow">&#45;&gt;</span></span> <span>?trash_dir:<a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> <span class="arrow">&#45;&gt;</span></span> <span>?jobs:int <span class="arrow">&#45;&gt;</span></span> <span>?feedback:<span>(<span><span>[ <a href="#type-feedback">feedback</a> <span>| <a href="../../B000/Exec/index.html#type-feedback">B000.Exec.feedback</a></span> ]</span> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
<span>unit <span class="arrow">&#45;&gt;</span></span> <span><span>(<a href="#type-t">t</a>, string)</span> <a href="../../../ocaml/Stdlib/index.html#type-result">result</a></span></span></code></div><div class="spec-doc"><p><code>memo</code> is a simpler <a href="#val-create"><code>create</code></a></p><ul><li><code>hash_fun</code> defaults to <a href="../../B00_std/Hash/Xxh_64/index.html"><code>B00_std.Hash.Xxh_64</code></a>.</li><li><code>jobs</code> defaults to <a href="../../B00_std/Os/Cpu/index.html#val-logical_count"><code>B00_std.Os.Cpu.logical_count</code></a>.</li><li><code>env</code> defaults to <a href="../../B00_std/Os/Env/index.html#val-current"><code>B00_std.Os.Env.current</code></a></li><li><code>cwd</code> defaults to <a href="../../B00_std/Os/Dir/index.html#val-cwd"><code>B00_std.Os.Dir.cwd</code></a></li><li><code>cache_dir</code> defaults to <code>Fpath.(cwd / &quot;_b0&quot; / &quot;.cache&quot;)</code></li><li><code>trash_dir</code> defaults to <code>Fpath.(cwd / &quot;_b0&quot; / &quot;.trash&quot;)</code></li><li><code>feedback</code> defaults to a nop.</li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-clock" class="anchored"><a href="#val-clock" class="anchor"></a><code><span><span class="keyword">val</span> clock : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../B00_std/Time/index.html#type-counter">B00_std.Time.counter</a></span></code></div><div class="spec-doc"><p><code>clock m</code> is <code>m</code>'s clock.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-cpu_clock" class="anchored"><a href="#val-cpu_clock" class="anchor"></a><code><span><span class="keyword">val</span> cpu_clock : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../B00_std/Time/index.html#type-cpu_counter">B00_std.Time.cpu_counter</a></span></code></div><div class="spec-doc"><p><code>cpu_clock m</code> is <code>m</code>'s cpu clock.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-win_exe" class="anchored"><a href="#val-win_exe" class="anchor"></a><code><span><span class="keyword">val</span> win_exe : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>win_exe m</code> is <code>true</code> if we spawn windows executables. This affects tool lookups. Defaults to <code>Sys</code>.win32.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-tool_lookup" class="anchored"><a href="#val-tool_lookup" class="anchor"></a><code><span><span class="keyword">val</span> tool_lookup : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-tool_lookup">tool_lookup</a></span></code></div><div class="spec-doc"><p><code>tool_lookup m</code> is <code>m</code>'s tool lookup function.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-env" class="anchored"><a href="#val-env" class="anchor"></a><code><span><span class="keyword">val</span> env : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../Env/index.html#type-t">Env.t</a></span></code></div><div class="spec-doc"><p><code>env m</code> is <code>m</code>'s environment.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-reviver" class="anchored"><a href="#val-reviver" class="anchor"></a><code><span><span class="keyword">val</span> reviver : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../B000/Reviver/index.html#type-t">B000.Reviver.t</a></span></code></div><div class="spec-doc"><p><code>reviver m</code> is <code>m</code>'s reviver.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-guard" class="anchored"><a href="#val-guard" class="anchor"></a><code><span><span class="keyword">val</span> guard : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../B000/Guard/index.html#type-t">B000.Guard.t</a></span></code></div><div class="spec-doc"><p><code>guard m</code> is <code>m</code>'s guard.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-exec" class="anchored"><a href="#val-exec" class="anchor"></a><code><span><span class="keyword">val</span> exec : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../B000/Exec/index.html#type-t">B000.Exec.t</a></span></code></div><div class="spec-doc"><p><code>exec m</code> is <code>m</code>'s executors.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-trash" class="anchored"><a href="#val-trash" class="anchor"></a><code><span><span class="keyword">val</span> trash : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../B000/Trash/index.html#type-t">B000.Trash.t</a></span></code></div><div class="spec-doc"><p><code>trash m</code> is <code>m</code>'s trash.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-has_failures" class="anchored"><a href="#val-has_failures" class="anchor"></a><code><span><span class="keyword">val</span> has_failures : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>has_failures m</code> is <code>true</code> iff at least one operation has failed.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-hash_string" class="anchored"><a href="#val-hash_string" class="anchor"></a><code><span><span class="keyword">val</span> hash_string : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <a href="../../B00_std/Hash/index.html#type-t">B00_std.Hash.t</a></span></code></div><div class="spec-doc"><p><code>hash_string m s</code> is <a href="../../B000/Reviver/index.html#val-hash_string"><code>B000.Reviver.hash_string</code></a><code> (reviver m) s</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-hash_file" class="anchored"><a href="#val-hash_file" class="anchor"></a><code><span><span class="keyword">val</span> hash_file : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<a href="../../B00_std/Hash/index.html#type-t">B00_std.Hash.t</a>, string)</span> <a href="../../../ocaml/Stdlib/index.html#type-result">result</a></span></span></code></div><div class="spec-doc"><p><code>hash_file m f</code> is <a href="../../B000/Reviver/index.html#val-hash_file"><code>B000.Reviver.hash_file</code></a><code> (reviver m) f</code>. Note that these file hashes operations are memoized.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-stir" class="anchored"><a href="#val-stir" class="anchor"></a><code><span><span class="keyword">val</span> stir : <span>block:bool <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>stir ~block m</code> runs the memoizer a bit. If <code>block</code> is <code>true</code> blocks until the memoizer is stuck with no operation to execute.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-status" class="anchored"><a href="#val-status" class="anchor"></a><code><span><span class="keyword">val</span> status : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(unit, <a href="../../B000/Op/index.html#type-aggregate_error">B000.Op.aggregate_error</a>)</span> <a href="../../../ocaml/Stdlib/index.html#type-result">result</a></span></span></code></div><div class="spec-doc"><p><code>status m</code> looks for aggregate errors in <code>m</code> in <code>ops m</code>, see <a href="../../B000/Op/index.html#type-aggregate_error"><code>B000.Op.aggregate_error</code></a> for details.</p><p>Usually called after a blocking <a href="#val-stir"><code>stir</code></a> to check everything executed as expected. The function itself has no effect more operations can be on <code>m</code> afterwards. If you are only interested in checking if a failure occured in the memo <a href="#val-has_failures"><code>has_failures</code></a> is faster.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-delete_trash" class="anchored"><a href="#val-delete_trash" class="anchor"></a><code><span><span class="keyword">val</span> delete_trash : <span>block:bool <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(unit, string)</span> <a href="../../../ocaml/Stdlib/index.html#type-result">result</a></span></span></code></div><div class="spec-doc"><p><code>delete_trash ~block m</code> is <a href="../../B000/Trash/index.html#val-delete"><code>B000.Trash.delete</code></a><code> ~block (trash m)</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-ops" class="anchored"><a href="#val-ops" class="anchor"></a><code><span><span class="keyword">val</span> ops : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../B000/Op/index.html#type-t">B000.Op.t</a> list</span></span></code></div><div class="spec-doc"><p><code>ops m</code> is the list of operations that were submitted to the memoizer</p></div></div><h2 id="marks"><a href="#marks" class="anchor"></a>Activity marks</h2><p>Activity marks are just identifiers used for UI purposes to watermark the activity – notably build operations – occuring in the memo.</p><div class="odoc-spec"><div class="spec value" id="val-mark" class="anchored"><a href="#val-mark" class="anchor"></a><code><span><span class="keyword">val</span> mark : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p><code>mark m</code> is <code>m</code>'s mark.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-with_mark" class="anchored"><a href="#val-with_mark" class="anchor"></a><code><span><span class="keyword">val</span> with_mark : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>mark m mark</code> is <code>m</code> but operations performed on <code>m</code> are marked by <code>mark</code>.</p></div></div><h3 id="proc"><a href="#proc" class="anchor"></a>Procedures</h3><div class="odoc-spec"><div class="spec value" id="val-run_proc" class="anchored"><a href="#val-run_proc" class="anchor"></a><code><span><span class="keyword">val</span> run_proc : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="../../B00_std/Fut/index.html#type-t">B00_std.Fut.t</a></span>)</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>run m proc</code> calls <code>proc ()</code> and handles any <a href="#val-fail"><code>fail</code></a>ure. This also catches non-asynchronous uncaught exceptions and turns them into <code>`Fail</code> notification operations.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-fail" class="anchored"><a href="#val-fail" class="anchor"></a><code><span><span class="keyword">val</span> fail : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span class="type-var">'a</span>, <a href="../../../ocaml/Stdlib/Format/index.html#type-formatter">Format.formatter</a>, unit, <span class="type-var">'b</span>)</span> <a href="../../../ocaml/Stdlib/index.html#type-format4">format4</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p><code>fail m fmt ...</code> fails the procedure via a <a href="#val-notify"><code>notify</code></a> operation.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-fail_if_error" class="anchored"><a href="#val-fail_if_error" class="anchor"></a><code><span><span class="keyword">val</span> fail_if_error : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span class="type-var">'a</span>, string)</span> <a href="../../../ocaml/Stdlib/index.html#type-result">result</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p><code>fail_if_error m r</code> is <code>v</code> if <code>r</code> is <code>Ok v</code> and <code>fail m &quot;%s&quot; e</code> if <code>r</code> is <code>Error _</code>.</p></div></div><h2 id="feedback"><a href="#feedback" class="anchor"></a>Feedback</h2><p><b>XXX</b> This needs a bit of reviewing.</p><div class="odoc-spec"><div class="spec value" id="val-notify" class="anchored"><a href="#val-notify" class="anchor"></a><code><span><span class="keyword">val</span> notify : <span>?k:<span>(<span>unit <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
<span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>[ `Fail <span>| `Warn</span> <span>| `Start</span> <span>| `End</span> <span>| `Info</span> ]</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span class="type-var">'a</span>, <a href="../../../ocaml/Stdlib/Format/index.html#type-formatter">Format.formatter</a>, unit, unit)</span> <a href="../../../ocaml/Stdlib/index.html#type-format4">format4</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p><code>notify m kind msg</code> is a notification <code>msg</code> of kind <code>kind</code>. Note that a <code>`Fail</code> notification will entail a <code>finish_error</code>, see also <a href="#val-fail"><code>fail</code></a> and <a href="#val-fail_if_error"><code>fail_if_error</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-notify_if_error" class="anchored"><a href="#val-notify_if_error" class="anchor"></a><code><span><span class="keyword">val</span> notify_if_error : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>[ `Fail <span>| `Warn</span> <span>| `Start</span> <span>| `End</span> <span>| `Info</span> ]</span> <span class="arrow">&#45;&gt;</span></span> <span>use:<span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span>
<span><span><span>(<span class="type-var">'a</span>, string)</span> <a href="../../../ocaml/Stdlib/index.html#type-result">result</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p><code>notify_if_error m kind ~use r</code> is <code>v</code> if <code>r</code> is <code>Ok v</code>. If <code>r</code> is <code>Error e</code>, a notification of kind <code>kind</code> is added to <code>m</code> and <code>use</code> is returned. Note that a <code>`Fail</code> notification will entail a <code>finish_error</code>, see also <a href="#val-fail"><code>fail</code></a> and <a href="#val-fail_if_error"><code>fail_if_error</code></a>.</p></div></div><h2 id="files"><a href="#files" class="anchor"></a>Files and directories</h2><div class="odoc-spec"><div class="spec value" id="val-file_ready" class="anchored"><a href="#val-file_ready" class="anchor"></a><code><span><span class="keyword">val</span> file_ready : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>ready m p</code> declares path <code>p</code> to be ready, that is exists and is up-to-date in <code>b</code>. This is typically used with source files and files external to the build (e.g. installed libraries).</p></div></div><div class="odoc-spec"><div class="spec value" id="val-read" class="anchored"><a href="#val-read" class="anchor"></a><code><span><span class="keyword">val</span> read : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> <span class="arrow">&#45;&gt;</span></span> <span>string <a href="../../B00_std/Fut/index.html#type-t">B00_std.Fut.t</a></span></span></code></div><div class="spec-doc"><p><code>read m file k</code> is a future that determines with the contents <code>s</code> of file <code>file</code> when it becomes ready in <code>m</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-write" class="anchored"><a href="#val-write" class="anchor"></a><code><span><span class="keyword">val</span> write : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>?stamp:string <span class="arrow">&#45;&gt;</span></span> <span>?reads:<span><a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span>?mode:int <span class="arrow">&#45;&gt;</span></span>
<span><a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span><span>(string, string)</span> <a href="../../../ocaml/Stdlib/index.html#type-result">result</a></span>)</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>write m ~reads file w</code> writes <code>file</code> with data <code>w ()</code> and mode <code>mode</code> (defaults to <code>0o644</code>) when <code>reads</code> are ready. <code>w</code>'s result must only depend on <code>reads</code> and <code>stamp</code> (defaults to <code>&quot;&quot;</code>).</p></div></div><div class="odoc-spec"><div class="spec value" id="val-copy" class="anchored"><a href="#val-copy" class="anchor"></a><code><span><span class="keyword">val</span> copy : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>?mode:int <span class="arrow">&#45;&gt;</span></span> <span>?linenum:int <span class="arrow">&#45;&gt;</span></span> <span>src:<a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>copy m ~mode ?linenum ~src dst</code> copies file <code>src</code> to <code>dst</code> with mode <code>mode</code> (defaults to <code>0o644</code>) when <code>src</code> is ready. If <code>linenum</code> is specified, the following line number directive is prependend in <code>dst</code> to the contents of <code>src</code>:</p><pre><code>#line $(linenum) &quot;$(src)&quot;</code></pre></div></div><div class="odoc-spec"><div class="spec value" id="val-mkdir" class="anchored"><a href="#val-mkdir" class="anchor"></a><code><span><span class="keyword">val</span> mkdir : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>?mode:int <span class="arrow">&#45;&gt;</span></span> <span><a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="../../B00_std/Fut/index.html#type-t">B00_std.Fut.t</a></span></span></code></div><div class="spec-doc"><p><code>mkdir m dir p</code> is a future that determines with <code>()</code> when the directory path <code>p</code> has been created with mode <code>mode</code> (defaults to <code>0o755</code>). The behaviour with respect to file permission of intermediate path segments matches <code>Os</code>.Dir.create.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-delete" class="anchored"><a href="#val-delete" class="anchor"></a><code><span><span class="keyword">val</span> delete : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="../../B00_std/Fut/index.html#type-t">B00_std.Fut.t</a></span></span></code></div><div class="spec-doc"><p><code>delete m p</code> is a future that determines with <code>()</code> when path <code>p</code> is deleted (trashed in fact) and free to reuse.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-wait_files" class="anchored"><a href="#val-wait_files" class="anchor"></a><code><span><span class="keyword">val</span> wait_files : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="../../B00_std/Fut/index.html#type-t">B00_std.Fut.t</a></span></span></code></div><div class="spec-doc"><p><code>wait_files m files</code> is a future that deterines with <code>()</code> when all <code>files</code> are ready in <code>m</code>. <b>FIXME</b> Unclear whether we really want this.</p></div></div><h2 id="spawn"><a href="#spawn" class="anchor"></a>Memoizing tool spawns</h2><p><b>TODO.</b> Can't we simplify the cmd/tool/tool_lookup dance ?.</p><div class="odoc-spec"><div class="spec type" id="type-cmd" class="anchored"><a href="#type-cmd" class="anchor"></a><code><span><span class="keyword">type</span> cmd</span></code></div><div class="spec-doc"><p>The type for memoized tool invocations.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-tool" class="anchored"><a href="#type-tool" class="anchor"></a><code><span><span class="keyword">type</span> tool</span></code></div><div class="spec-doc"><p>The type for memoized tools.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-tool" class="anchored"><a href="#val-tool" class="anchor"></a><code><span><span class="keyword">val</span> tool : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Tool/index.html#type-t">Tool.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../B00_std/Cmd/index.html#type-t">B00_std.Cmd.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-cmd">cmd</a></span></code></div><div class="spec-doc"><p><code>tool m t</code> is tool <code>t</code> memoized. Use the resulting function to spawn the tool with the given arguments.</p><p><b>TODO</b> explain better how this all works. If the path given to <code>Tool.t</code> is not made of a single path segment it is not search in the environmet and it is the duty of the client to ensure it gets ready at some point. Either by a direct call to <a href="#val-file_ready"><code>file_ready</code></a> or by another file write.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-tool_opt" class="anchored"><a href="#val-tool_opt" class="anchor"></a><code><span><span class="keyword">val</span> tool_opt : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Tool/index.html#type-t">Tool.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span><a href="../../B00_std/Cmd/index.html#type-t">B00_std.Cmd.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-cmd">cmd</a>)</span> option</span> <a href="../../B00_std/Fut/index.html#type-t">B00_std.Fut.t</a></span></span></code></div><div class="spec-doc"><p><code>tool_opt m t</code> is like <a href="#val-tool"><code>tool</code></a>, except <code>None</code> is returned if the tool cannot be found. y</p></div></div><div class="odoc-spec"><div class="spec value" id="val-spawn" class="anchored"><a href="#val-spawn" class="anchor"></a><code><span><span class="keyword">val</span> spawn : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>?stamp:string <span class="arrow">&#45;&gt;</span></span> <span>?reads:<span><a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span>?writes:<span><a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span>?env:<a href="../../B00_std/Os/Env/index.html#type-t">B00_std.Os.Env.t</a> <span class="arrow">&#45;&gt;</span></span> <span>?cwd:<a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> <span class="arrow">&#45;&gt;</span></span>
<span>?stdin:<a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> <span class="arrow">&#45;&gt;</span></span> <span>?stdout:<a href="../../B000/Op/Spawn/index.html#type-stdo">B000.Op.Spawn.stdo</a> <span class="arrow">&#45;&gt;</span></span> <span>?stderr:<a href="../../B000/Op/Spawn/index.html#type-stdo">B000.Op.Spawn.stdo</a> <span class="arrow">&#45;&gt;</span></span> <span>?success_exits:<a href="../../B000/Op/Spawn/index.html#type-success_exits">B000.Op.Spawn.success_exits</a> <span class="arrow">&#45;&gt;</span></span> <span>?post_exec:<span>(<span><a href="../../B000/Op/index.html#type-t">B000.Op.t</a> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
<span>?k:<span>(<span>int <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-cmd">cmd</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>spawn m ~reads ~writes ~env ~cwd ~stdin ~stdout ~stderr
      ~success_exits cmd</code> spawns <code>cmd</code> once <code>reads</code> files are ready and makes files <code>writes</code> ready if the spawn succeeds and the file exists. The rest of the arguments are:</p><ul><li><code>stdin</code> reads input from the given file. If unspecified reads from the standard input of the program running the build. <b>Warning.</b> The file is not automatically added to <code>reads</code>, this allows for example to use <code>B00_std</code>.Os.File.null.</li><li><code>stdout</code> and <code>stderr</code>, the redirections for the standard outputs of the command, see <code>stdo</code>. Path to files are created if needed. <b>Warning.</b> File redirections are not automatically added to <code>writes</code>; this allows for example to use <code>B00_std</code>.Os.File.null.</li><li><code>success_exits</code> the exit codes that determine if the build operation is successful (defaults to <code>0</code>, use <code>[]</code> to always succeed)</li><li><code>env</code>, environment variables added to the build environment. This overrides environment variables read by the tool in the build environment except for forced one. It also allows to specify environment that may not be mentioned by the running tool's <a href="../Tool/index.html#val-v">environment specification</a>.</li><li><code>cwd</code> the current working directory. Default is <code>cwd</code>. In general it's better to avoid using relative file paths and tweaking the <code>cwd</code>. Construct your paths using the absolute <span class="xref-unresolved">directory functions</span> and make your invocations independent from the <code>cwd</code>.</li><li><code>post_exec</code>, if specified is called with the build operation after it has been executed or revived. If it was executed this is called before the operation gets recorded. It can be used to define the <code>reads</code> and <code>writes</code> of the operation if they are difficult to find out before hand. <b>Do not</b> access <code>m</code> in that function.</li><li><code>k</code>, if specified a function invoked once the spawn has succesfully executed with the exit code.</li><li><code>stamp</code> is used for caching if two spawns diff only in their stamp they will cache to different keys. This can be used to memoize tool whose outputs may not entirely depend on the environment, the cli stamp and the the content of read files.</li></ul><p><b>Note.</b> If the tool spawn acts on a sort of &quot;main&quot; file (e.g. a source file) it should be specified as the first element of <code>reads</code>, this is interpreted specially by certain build tracer.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-spawn'" class="anchored"><a href="#val-spawn'" class="anchor"></a><code><span><span class="keyword">val</span> spawn' : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>?stamp:string <span class="arrow">&#45;&gt;</span></span> <span>?reads:<span><a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span>writes_root:<a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> <span class="arrow">&#45;&gt;</span></span> <span>?writes:<span>(<span><a href="../../B000/Op/index.html#type-t">B000.Op.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> list</span>)</span> <span class="arrow">&#45;&gt;</span></span>
<span>?env:<a href="../../B00_std/Os/Env/index.html#type-t">B00_std.Os.Env.t</a> <span class="arrow">&#45;&gt;</span></span> <span>?cwd:<a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> <span class="arrow">&#45;&gt;</span></span> <span>?stdin:<a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> <span class="arrow">&#45;&gt;</span></span> <span>?stdout:<a href="../../B000/Op/Spawn/index.html#type-stdo">B000.Op.Spawn.stdo</a> <span class="arrow">&#45;&gt;</span></span> <span>?stderr:<a href="../../B000/Op/Spawn/index.html#type-stdo">B000.Op.Spawn.stdo</a> <span class="arrow">&#45;&gt;</span></span> <span>?success_exits:<a href="../../B000/Op/Spawn/index.html#type-success_exits">B000.Op.Spawn.success_exits</a> <span class="arrow">&#45;&gt;</span></span> <span>?k:<span>(<span>int <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
<span><a href="#type-cmd">cmd</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>spawn'</code> is like <a href="#val-spawn"><code>spawn</code></a> except the actual file paths written by the spawn need not be determined before the spawn. Only the root directory of writes need to be specified via <code>writes_root</code>. After the spawn executes the writes can be determined via the <code>writes</code> function, the returned paths must be absolute and be prefixed by <code>writes_root</code> (defaults to recursively list all the files rootet in <code>writes_root</code>).</p></div></div></div></body></html>